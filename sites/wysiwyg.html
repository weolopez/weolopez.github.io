<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enhanced WYSIWYG Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Global styles (for the demo page) */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
  </style>
</head>
<body>
  <!-- Use the custom web component -->
  <wysiwyg-editor></wysiwyg-editor>

  <script>
    class WysiwygEditor extends HTMLElement {
      constructor() {
        super();
        // Attach a shadow DOM for encapsulation.
        this.attachShadow({ mode: 'open' });
        this.shadowRoot.innerHTML = `
          <style>
            .editor-container {
              max-width: 1000px;
              margin: 0 auto;
              background: #fff;
              border: 1px solid #ccc;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              font-family: Arial, sans-serif;
            }
            .toolbar {
              background: #eee;
              padding: 10px;
              display: flex;
              flex-wrap: wrap;
              gap: 5px;
              align-items: center;
            }
            .toolbar button,
            .toolbar select {
              padding: 5px 10px;
              font-size: 14px;
              cursor: pointer;
            }
            .toolbar button:disabled {
              opacity: 0.5;
              cursor: not-allowed;
            }
            .editor {
              min-height: 400px;
              padding: 20px;
              outline: none;
            }
            /* Default styling for section elements */
            section {
              border: 1px dashed #999;
              padding: 10px;
              margin: 10px 0;
              background: #fafafa;
            }
            /* Highlight active (selected) section */
            .active-section {
              outline: 2px dashed blue;
            }
          </style>
          <div class="editor-container">
            <div class="toolbar">
              <!-- Global Template Selector -->
              <label for="globalTemplate">Global Template:</label>
              <select id="globalTemplate">
                <option value="blank">Blank</option>
                <option value="simple">Simple Document</option>
                <option value="twoColumn">Two Column Layout</option>
              </select>
              <!-- Text Formatting Buttons -->
              <button id="btnBold" title="Bold">B</button>
              <button id="btnItalic" title="Italic">I</button>
              <button id="btnUnderline" title="Underline">U</button>
              <!-- Insertion Buttons -->
              <button id="btnAddSection" title="Add Section">Add Section</button>
              <button id="btnAddHeading" title="Add Heading">Add Heading</button>
              <button id="btnAddParagraph" title="Add Paragraph">Add Paragraph</button>
              <button id="btnAddImage" title="Add Image">Add Image</button>
              <button id="btnAddList" title="Add List">Add List</button>
              <button id="btnAddCustom" title="Add Custom HTML">Add Custom HTML</button>
              <!-- Section Template Button (enabled only when a section is selected) -->
              <button id="btnSectionTemplate" title="Apply Section Template" disabled>Section Template</button>
            </div>
            <!-- The contenteditable editor area -->
            <div id="editor" class="editor" contenteditable="true">
              <!-- Global template content will be loaded here -->
            </div>
          </div>
        `;

        // Global templates for the entire editor.
        this.templates = {
          blank: '<p>Start your content here...</p>',
          simple: `
            <h1>Title</h1>
            <p>Write your introduction here...</p>
            <section contenteditable="true">
              <h2>Section Title</h2>
              <p>Section content...</p>
            </section>
          `,
          twoColumn: `
            <div style="display: flex; gap:10px;">
              <div style="flex: 1; padding: 10px; border-right: 1px solid #ccc;" contenteditable="true">
                <h2>Column 1</h2>
                <p>Content for column 1...</p>
              </div>
              <div style="flex: 1; padding: 10px;" contenteditable="true">
                <h2>Column 2</h2>
                <p>Content for column 2...</p>
              </div>
            </div>
          `
        };

        // Section-specific templates.
        this.sectionTemplates = {
          simple: '<h2>Section Title</h2><p>Section content...</p>',
          twoColumn: `
            <div style="display: flex; gap:10px;">
              <div style="flex: 1; padding: 10px; border-right: 1px solid #ccc;" contenteditable="true">
                <p>Column 1 content...</p>
              </div>
              <div style="flex: 1; padding: 10px;" contenteditable="true">
                <p>Column 2 content...</p>
              </div>
            </div>
          `,
          imageSection: '<h2>Image Section</h2><img src="https://via.placeholder.com/150" alt="Placeholder" style="max-width:100%;" />'
        };

        // Keep track of the currently active (selected) section.
        this.activeSection = null;
      }

      connectedCallback() {
        // Grab references to key elements.
        this.editor = this.shadowRoot.getElementById('editor');
        this.globalTemplateSelect = this.shadowRoot.getElementById('globalTemplate');
        this.btnBold = this.shadowRoot.getElementById('btnBold');
        this.btnItalic = this.shadowRoot.getElementById('btnItalic');
        this.btnUnderline = this.shadowRoot.getElementById('btnUnderline');
        this.btnAddSection = this.shadowRoot.getElementById('btnAddSection');
        this.btnAddHeading = this.shadowRoot.getElementById('btnAddHeading');
        this.btnAddParagraph = this.shadowRoot.getElementById('btnAddParagraph');
        this.btnAddImage = this.shadowRoot.getElementById('btnAddImage');
        this.btnAddList = this.shadowRoot.getElementById('btnAddList');
        this.btnAddCustom = this.shadowRoot.getElementById('btnAddCustom');
        this.btnSectionTemplate = this.shadowRoot.getElementById('btnSectionTemplate');

        // Load the global blank template on initialization.
        this.setGlobalTemplate('blank');

        // When the global template changes, warn the user before replacing current content.
        this.globalTemplateSelect.addEventListener('change', (e) => {
          if (confirm('Changing the global template will overwrite your current content. Continue?')) {
            this.setGlobalTemplate(e.target.value);
          } else {
            e.target.value = 'blank';
          }
        });

        // Text formatting buttons use execCommand to style selected text.
        this.btnBold.addEventListener('click', () => this.applyTextStyle('bold'));
        this.btnItalic.addEventListener('click', () => this.applyTextStyle('italic'));
        this.btnUnderline.addEventListener('click', () => this.applyTextStyle('underline'));

        // Insertion buttons for adding new elements.
        this.btnAddSection.addEventListener('click', () => {
          const sectionHTML = `
            <section contenteditable="true" style="border:1px dashed #999; padding:10px; margin:10px 0;">
              <h2>New Section</h2>
              <p>Section content here...</p>
            </section>`;
          this.insertHTMLAtCursor(sectionHTML);
        });
        this.btnAddHeading.addEventListener('click', () => {
          const headingHTML = `<h2 contenteditable="true">New Heading</h2>`;
          this.insertHTMLAtCursor(headingHTML);
        });
        this.btnAddParagraph.addEventListener('click', () => {
          const paragraphHTML = `<p contenteditable="true">New paragraph...</p>`;
          this.insertHTMLAtCursor(paragraphHTML);
        });
        this.btnAddImage.addEventListener('click', () => {
          const imageUrl = prompt('Enter image URL:');
          if (imageUrl) {
            const altText = prompt('Enter alt text (optional):', '');
            const imageHTML = `<img src="${imageUrl}" alt="${altText}" style="max-width:100%; display:block; margin:10px 0;" />`;
            this.insertHTMLAtCursor(imageHTML);
          }
        });
        this.btnAddList.addEventListener('click', () => {
          const listHTML = `
            <ul contenteditable="true">
              <li>List item 1</li>
              <li>List item 2</li>
            </ul>`;
          this.insertHTMLAtCursor(listHTML);
        });
        this.btnAddCustom.addEventListener('click', () => {
          const customHTML = prompt('Enter custom HTML to insert:');
          if (customHTML) {
            this.insertHTMLAtCursor(customHTML);
          }
        });

        // The Section Template button applies a section-specific template to the active section.
        this.btnSectionTemplate.addEventListener('click', () => {
          if (this.activeSection) {
            const templateType = prompt('Enter section template type (simple, twoColumn, imageSection):', 'simple');
            if (templateType && this.sectionTemplates[templateType]) {
              // Replace the content of the active section with the chosen template.
              this.activeSection.innerHTML = this.sectionTemplates[templateType];
            } else {
              alert('Invalid template type.');
            }
          }
        });

        // Listen for click events inside the editor to detect and highlight sections.
        this.editor.addEventListener('click', (e) => {
          let section = e.target;
          while (section && section !== this.editor) {
            if (section.tagName === 'SECTION') break;
            section = section.parentNode;
          }
          if (section && section !== this.editor) {
            this.setActiveSection(section);
          } else {
            this.clearActiveSection();
          }
        });
      }

      /** Set the global template content in the editor. **/
      setGlobalTemplate(templateKey) {
        const html = this.templates[templateKey] || this.templates.blank;
        this.editor.innerHTML = html;
        this.clearActiveSection();
      }

      /** Mark a section as active (selected) and apply a highlight border. **/
      setActiveSection(section) {
        // Remove highlighting from any previously active section.
        if (this.activeSection && this.activeSection !== section) {
          this.activeSection.classList.remove('active-section');
        }
        this.activeSection = section;
        this.activeSection.classList.add('active-section');
        // Enable the Section Template button.
        this.btnSectionTemplate.disabled = false;
      }

      /** Clear any active section and disable the Section Template button. **/
      clearActiveSection() {
        if (this.activeSection) {
          this.activeSection.classList.remove('active-section');
          this.activeSection = null;
        }
        this.btnSectionTemplate.disabled = true;
      }

      /** Apply a text formatting command (bold, italic, underline) to the selected text. **/
      applyTextStyle(command) {
        this.editor.focus();
        document.execCommand(command, false, null);
      }

      /** Insert an HTML string at the current caret location in the editor. **/
      insertHTMLAtCursor(html) {
        this.editor.focus();
        if (document.queryCommandSupported('insertHTML')) {
          document.execCommand('insertHTML', false, html);
        } else {
          // Fallback using the Selection and Range API.
          let sel, range;
          if (window.getSelection) {
            sel = window.getSelection();
            if (sel.getRangeAt && sel.rangeCount) {
              range = sel.getRangeAt(0);
              range.deleteContents();
              const el = document.createElement('div');
              el.innerHTML = html;
              const frag = document.createDocumentFragment();
              let node, lastNode;
              while ((node = el.firstChild)) {
                lastNode = frag.appendChild(node);
              }
              range.insertNode(frag);
              if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
              }
            }
          }
        }
      }
    }

    // Register the custom element.
    customElements.define('wysiwyg-editor', WysiwygEditor);
  </script>
</body>
</html>