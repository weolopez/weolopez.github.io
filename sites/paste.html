<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paste Image</title>
    <style>
        body { color: silver;margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; font-family: sans-serif; background-color: rgb(36, 34, 41)}
        canvas { border: 1px solid #ccc; max-width: 95vw; max-height: 90vh; display: none; object-fit: contain; }
        p { margin-bottom: 10px; }
    </style>
</head>
<body>
<img id="myid" onload="form_base64_decode_preview(this)" onplay="this.onload()" onloadedmetadata="this.onload()" onerror="this.support_decode_preview=false" alt="" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAQCAYAAACm53kpAAAAPklEQVR4nOXOsREAMAyDQMz+OztDuEjB9+g0C8vBnOr7wO6ceomTOImTOImTOImTOImTOImTOImTOH8f+O0B+ikGHQNviZ0AAAAASUVORK5CYII=">    <script>
        const canvas = document.getElementById('pasteCanvas');
        const ctx = canvas.getContext('2d');
        const instructionP = document.querySelector('p');

        function displayImageOnCanvas(imageSource) { // imageSource can be ImageBitmap or HTMLImageElement
            canvas.width = imageSource.width;
            canvas.height = imageSource.height;
            ctx.drawImage(imageSource, 0, 0);
            canvas.style.display = 'block';
            if (instructionP) instructionP.style.display = 'none';
        }

        document.body.onclick = async () => {
            if (!navigator.clipboard || !navigator.clipboard.read) {
                console.warn("Clipboard API (read) not fully supported.");
                // Alert removed for brevity, user can try standard paste
                return;
            }
            try {
                const clipboardItems = await navigator.clipboard.read();
                for (const item of clipboardItems) {
                    const imageType = item.types.find(type => type.startsWith('image/'));
                    if (imageType) {
                        const blob = await item.getType(imageType);
                        const imageBitmap = await createImageBitmap(blob);
                        displayImageOnCanvas(imageBitmap);
                        return;
                    }
                }
                // alert("No image found on clipboard via click method."); // Optional: re-add if needed
            } catch (err) {
                console.error('Error pasting image via click:', err);
                // alert(`Click paste error: ${err.name}.`); // Optional: re-add if needed
            }
        };

        document.addEventListener('paste', async (event) => {
            if (!event.clipboardData || !event.clipboardData.items) return;
            for (const item of event.clipboardData.items) {
                if (item.type.startsWith('image/')) {
                    event.preventDefault();
                    const blob = item.getAsFile();
                    if (blob) {
                        try {
                            const imageBitmap = await createImageBitmap(blob);
                            displayImageOnCanvas(imageBitmap);
                        } catch (err) {
                            console.error('Error processing pasted image blob:', err);
                            alert('Error processing pasted image.');
                        }
                        return;
                    }
                }
            }
        });

        function displayBase64Image(rawStrFromUrl) {
            let fullDataUrl;

            // Defensive check for null or undefined input
            if (typeof rawStrFromUrl !== 'string') {
                console.error('Invalid input to displayBase64Image: not a string.', rawStrFromUrl);
                alert('Internal error: image data is not a string.');
                return;
            }
            console.log('displayBase64Image received (first 100 chars):', rawStrFromUrl.substring(0,100));

            if (rawStrFromUrl.startsWith('data:image/')) {
                // It's already a data URL. We need to clean the payload part.
                const parts = rawStrFromUrl.split(';base64,');
                if (parts.length === 2) {
                    const prefix = parts[0] + ';base64,';
                    // Aggressively clean invalid Base64 chars from payload
                    const payload = parts[1].replace(/[^A-Za-z0-9+/=]/g, '');
                    fullDataUrl = prefix + payload;
                } else {
                    // Malformed data URI
                    console.error('Malformed data URI received (first 100 chars):', rawStrFromUrl.substring(0,100));
                    alert('Malformed data URI. Cannot display image.');
                    return;
                }
            } else {
                // It's assumed to be just the base64 data. Clean it and determine mime type.
                // Aggressively clean invalid Base64 chars from the entire string if not a data URI
                const cleanedPayload = rawStrFromUrl.replace(/[^A-Za-z0-9+/=]/g, '');
                
                let mimeType = 'image/jpeg'; // Default
                if (cleanedPayload.startsWith('/9j/')) { // JPEG
                    mimeType = 'image/jpeg';
                } else if (cleanedPayload.startsWith('iVBORw0KGgo')) { // PNG
                    mimeType = 'image/png';
                } else if (cleanedPayload.startsWith('R0lGODlh') || cleanedPayload.startsWith('GIF8')) { // GIF
                    mimeType = 'image/gif';
                } else if (cleanedPayload.startsWith('PHN2Zy')) { // SVG (base64 for "<svg")
                    mimeType = 'image/svg+xml';
                } else if (cleanedPayload.startsWith('UklGR')) { // WebP (RIFF header)
                    mimeType = 'image/webp';
                }
                // Add more MIME type detections if necessary based on Base64 prefixes
            }
                fullDataUrl = `data:${mimeType};base64,${cleanedPayload}`;
            const hiddenImg = document.getElementById('myid');
            if (hiddenImg) hiddenImg.src = fullDataUrl;
            
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            let imageParam = urlParams.get('image');
            if (imageParam) {
                try {
                    console.log('Raw imageParam from URL (first 100 chars):', typeof imageParam === 'string' ? imageParam.substring(0,100) : imageParam);
                    // Decode the URL-encoded characters (like %0D%0A)
                    const decodedImageParam = decodeURIComponent(imageParam);
                    console.log('Decoded imageParam (first 100 chars):', typeof decodedImageParam === 'string' ? decodedImageParam.substring(0,100) : decodedImageParam);
                    displayBase64Image(decodedImageParam);
                } catch (e) {
                    alert('Error processing image from URL parameter.');
                    console.error('Error with URL image param:', e);
                }
            }
        };
    </script>
</body>
</html>
