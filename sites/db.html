<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Lightweight IndexedDB API Demo</title>
  <script type="module" src="../wc/index-table-db.js"></script>
  <script type="module" src="../wc/db-buttons.js"></script>
</head>

<body>
  <ul id="tables">
    <li id="Users">
      <indexeddb-table db-name="JSONDB"></indexeddb-table>
    </li>
  </ul>
  <label for="dbName" onclick="showInputAndSetDbName()">Database Name:</label>
  <input type="text" id="dbName" style="display:none;" onblur="setDbName(this.value)" />
  <br />
  <db-buttons></db-buttons>
  <!-- <button onclick="createRecord()">Create</button>
  <button onclick="readRecord()">Read</button>
  <button onclick="updateRecord()">Update</button>
  <button onclick="deleteRecord()">Delete</button>
  <button onclick="dropAllTables()">Drop All Tables</button>
  <button onclick="deleteWorker()">Delete Worker</button>
  <button onclick="createWorker()">Create Worker</button> -->

  <!-- <script type="module">
    import { DB, drop } from "../js/db.js";
    setDbName("JSONDB");

    function setDbName(value) {
      window.dbName = value;
      const label = document.querySelector('label[for="dbName"]');
      label.textContent = `Database Name: ${value}`;
      //hide input
      const input = document.getElementById('dbName');
      input.style.display = 'none';
    }

    function showInputAndSetDbName() {
      const input = document.getElementById('dbName');
      if (input.style.display === 'none') {
        input.style.display = 'inline';
      } else {
        setDbName(input.value);
      }
    }

    window.createRecord()= async function() {
      await db.Users.add({
        name: "New User",
        email: "newuser@example.com"
      });
      alert("Record created!");
    }

    async function readRecord() {
      const db = new DB("../js/advanced-db-engine-worker.js");
      await db.init("MyComplexDB", mySchema, 1);
      const users = await db.Users.find({});
      console.log(users);
      alert("Check console for records.");
    }

    async function updateRecord() {
      const db = new DB("../js/advanced-db-engine-worker.js");
      await db.init("MyComplexDB", mySchema, 1);
      const user = await db.Users.find({ name: "New User" });
      if (user) {
        user.email = "updateduser@example.com";
        await db.Users.put(user);
        alert("Record updated!");
      } else {
        alert("User not found!");
      }
    }

    window.deleteRecord = async function () {
      const db = new DB("../js/advanced-db-engine-worker.js");
      await db.init("MyComplexDB", mySchema, 1);
      const user = await db.Users.find({ name: "New User" });
      if (user) {
        await db.Users.delete(user.id);
        alert("Record deleted!");
      } else {
        alert("User not found!");
      }
    }

    async function dropAllTables() {
      await drop("MyComplexDB");
      alert("All tables dropped!");
    }

    window.deleteWorker = async function() {
      // Implement worker deletion logic if needed
      alert("Worker deleted!");
    }

    window.createWorker = async function() {

      // 1) The schema is defined externally here in the main thread
      const mySchema = [
        {
          name: "Users",
          type: "Users",
          parentID: "",
          parentType: "",
          keyPath: "id",
          autoIncrement: true,
          indexes: [
            { name: "NameIndex", keyPath: "name" },
            { name: "EmailIndex", keyPath: "Email", options: { unique: true } }
          ],
          //validate: (data) => {
          //  if (!data.Name) throw new Error("User must have a name.");
          //  if (!data.Email) throw new Error("User must have an Email.");
          //}
        },
        {
          name: "Orders",
          type: "Users",
          parentID: "",
          parentType: "",
          keyPath: "id",
          autoIncrement: true,
          indexes: [
            { name: "NameIndex", keyPath: "name" }
          ],
          //validate: (data) => {
          //   if (!data.OrderName) throw new Error("Order must have an OrderName.");
          //}
        }
      ];
      db = new DB("../js/advanced-db-engine-worker.js");
      await db.init(window.dbName, mySchema, 10);
      // Implement worker creation logic if needed
      alert("Worker created!", await db.isWorkerRunning());
    }
  </script> -->
  <!-- <script type="module" >
import { DB, drop } from "../js/db-client.js";

   drop("MyComplexDB")

   // 1) Create the DB and specify which collections we support
   

   //await db.init();

   // 2) Create our DB wrapper, pointing to the worker script
 const db = new DB("../js/advanced-db-engine-worker.js");

 // 3) Initialize the worker-based engine with the external schema
 await db.init("MyComplexDB", mySchema, 1);


// 2) Add a top-level record (e.g. a user)
let alice = await db.Users.add({
  name: "Alice Smith",
  email: "alice@example.com"
});

alice.email = "alice@gmail.com"

if (alice) {
  alice = await db.Users.find({ id: alice.id });
}

// 2) Add a top-level record (e.g. a user)
let john = await db.Users.add({
    name: "John Smith",
    email: "john@example.com"
  })
  if (!john) {
    john = await db.Users.find({ name: "John Smith" });
  };
// alice now has { id: 1, type: "Users", parentID: "", parentType: "", _collectionName: "Users", ... }

// 2) Add a top-level record (e.g. a user)
let ao = await db.Orders.add({
  type: "Orders",
  name: "Widget Order",
  parentID: 1,
  parentType: "Users",
  quantity: 10
})
if (!ao) {
  ao = await db.Orders.find({ name: "Widget Order" });
};

let awo = await db.Orders.add({
  type: "Orders",
  name: "Widget Order2",
  parentID: 1,
  parentType: "Users",
  quantity: 10
})
if (!awo) {
  awo = await db.Orders.find({ name: "Widget Order2" });
};


// 3) Add a child record (e.g. an order) to Alice, using the parent's add() method
const order = await alice.add({
  type: "Orders",
  name: "Widget Order",
  quantity: 10
});

await alice.add({
    type: "Orders",
    name: "Service Order",
    quantity: 10
  });
await john.add({
    type: "Orders",
    name: "Widget Order",
    quantity: 10
  });
await john.add({
    type: "Orders",
    name: "Service Order",
    quantity: 10
  });  
// Under the hood, this calls db.Orders.add(childData, alice).
// That sets parentID=alice.id, parentType="Users", and appends { id: X } to alice["Orders"].

// 4) Let's confirm we can find that order
const aliceOrders = await alice.Orders //db.Orders.find({ id: alice.Orders[0] });
const order2 = aliceOrders[0];
//console.log(aliceOrders);
// foundOrder => the proxied object with the new orderâ€™s fields

// 5) Add a child record (e.g. device) to Alice
alice.add({
  type: "Devices",
  name: "iPhone 13"
});
console.error(await alice.toString())

// Under the hood, it calls db.Devices.add(..., alice), storing parentID=1, parentType="Users".
// Alice will have an array property: alice["Devices"] = [ { id: <deviceId> } ]

// 6) Removing a record
// This removes the order from db.Orders and also removes the order ID from alice["Orders"]
await alice.remove(order2);

// 7) Searching by any field
const foundUser = await db.Users.find({ name: "Alice Smith" });
console.log( await foundUser.toString() );

// 8) We could also directly add top-level devices if we wanted
const newDevice = db.Devices.add({ name: "Desktop PC" });
// This has no parent, so parentID="", parentType="".
    </script> -->
</body>

</html>