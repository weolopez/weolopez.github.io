<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Component IDE + Gemini AI</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --ai-color: #8e44ad;
            --border-color: #333;
            --sidebar-bg: #252526;
            --hover-bg: #2a2d2e;
            --active-bg: #37373d;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            height: 48px;
            background: #252526;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 10;
        }
        header h1 { 
            font-weight: 400; font-size: 1rem; margin: 0; 
            display: flex; align-items: center; gap: 10px; 
        }
        #ai-status {
            font-size: 11px;
            color: #aaa;
            margin-left: auto;
            display: none;
            align-items: center;
        }
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 10px 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: #969696;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }
        .list-container {
            flex: 1;
            overflow-y: auto;
            padding-top: 5px;
        }
        .item {
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        .item:hover { background: var(--hover-bg); }
        .item.active { background: var(--active-bg); color: #fff; box-shadow: inset 2px 0 0 var(--accent-color); }
        
        .item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-actions {
            display: none;
            gap: 4px;
        }
        .item:hover .item-actions {
            display: flex;
        }
        .action-btn {
            background: none; border: none; color: #888; cursor: pointer; padding: 2px;
            display: flex; align-items: center;
        }
        .action-btn:hover { color: #fff; }

        .add-btn {
            background: none; border: none; color: #ccc; cursor: pointer; padding: 2px; font-size: 16px;
        }
        .add-btn:hover { color: #fff; }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            min-width: 300px;
        }
        .preview-pane {
            width: 35%;
            display: flex;
            flex-direction: column;
            background: #fff;
            min-width: 250px;
        }
        .pane-header {
            background: #2d2d2d;
            padding: 4px 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: #969696;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 28px;
        }
        monaco-js-editor {
            flex: 1;
        }
        #preview-frame {
            flex: 1;
            border: none;
            background: #fdfdfd;
        }
        .spinner {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Database View Overlay */
        #db-overlay {
            display: none;
            position: fixed;
            top: 48px; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            padding: 40px;
        }
        .db-modal {
            background: #252526;
            width: 100%;
            max-width: 900px;
            height: 80%;
            margin: 0 auto;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
        }
        .db-table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border: 1px solid #333;
        }
        th { background: #333; }
        .db-controls {
            padding: 15px 20px;
            background: #2d2d2d;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid #444;
        }
    </style>
</head>
<body>

    <header>
        <h1>
            <svg width="18" height="18" viewBox="0 0 100 100" fill="currentColor"><path d="M78.5 13.5L42.1 49.9l36.4 36.6 8-8-28.4-28.6 28.4-28.6-8-8zM21.5 13.5l-8 8 28.4 28.6-28.4 28.6 8 8 36.4-36.6L21.5 13.5z"/></svg>
            Component Studio
        </h1>
        <button id="toggle-db-btn" style="margin-left: 20px; background: #3c3c3c; color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 11px;">View Database</button>
        <div id="ai-status"><span class="spinner"></span> AI Analysis...</div>
    </header>
    
    <div class="main-container">
        <!-- Explorer Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <span>Explorer</span>
                <button class="add-btn" id="new-file-btn" title="New File">+</button>
            </div>
            <div class="list-container" id="file-list"></div>
        </div>

        <div class="editor-pane">
            <monaco-js-editor></monaco-js-editor>
        </div>
        <div class="preview-pane">
            <div class="pane-header">Live Preview</div>
            <iframe id="preview-frame"></iframe>
        </div>
    </div>

    <!-- Database Visualizer -->
    <div id="db-overlay">
        <div class="db-modal">
            <div class="db-controls">
                <strong style="margin-right: auto">IndexedDB: ComponentStudioDB</strong>
                <button onclick="closeDB()" style="background:transparent; color:#888; border:none; cursor:pointer">âœ• Close</button>
            </div>
            <div class="db-table-container">
                <table id="db-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Content Size</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="db-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Load Monaco ESM via CDN -->
    <script type="module">
        import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.55.0/+esm';
        window.monaco = monaco;
        
        // Signal that monaco is ready
        window.dispatchEvent(new CustomEvent('monaco-ready'));
    </script>

    <script>
        // --- IndexedDB Management ---
        const DB_NAME = 'ComponentStudioDB';
        const STORE_NAME = 'files';
        
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function getAllFiles() {
            const db = await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                store.getAll().onsuccess = (e) => resolve(e.target.result);
            });
        }

        async function saveFile(file) {
            const db = await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const request = store.put(file);
                request.onsuccess = (e) => resolve(e.target.result);
            });
        }

        async function deleteFile(id) {
            const db = await initDB();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                store.delete(id).onsuccess = () => resolve();
            });
        }

        // --- Database CRUD Visualization ---
        const dbOverlay = document.getElementById('db-overlay');
        const dbTbody = document.getElementById('db-tbody');

        document.getElementById('toggle-db-btn').onclick = async () => {
            dbOverlay.style.display = 'block';
            renderDBTable();
        };

        function closeDB() {
            dbOverlay.style.display = 'none';
        }

        async function renderDBTable() {
            const files = await getAllFiles();
            dbTbody.innerHTML = '';
            files.forEach(file => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${file.id}</td>
                    <td><input type="text" value="${file.name}" onchange="updateFileName(${file.id}, this.value)" style="background:#1e1e1e; color:white; border:1px solid #444; padding:2px"></td>
                    <td>${file.content.length} chars</td>
                    <td>
                        <button onclick="handleTableDelete(${file.id})" style="color:#f48771; background:none; border:none; cursor:pointer">Delete</button>
                    </td>
                `;
                dbTbody.appendChild(tr);
            });
        }

        window.updateFileName = async (id, newName) => {
            const files = await getAllFiles();
            const file = files.find(f => f.id === id);
            if (file) {
                file.name = newName;
                await saveFile(file);
                refreshFileList();
            }
        };

        window.handleTableDelete = async (id) => {
            await deleteFile(id);
            renderDBTable();
            refreshFileList();
        };

        // --- Web Components & UI ---
        class MonacoJsEditor extends HTMLElement {
            constructor() {
                super();
                this._editor = null;
                this._currentFileId = null;
                this._currentFileName = '';
            }

            connectedCallback() {
                this.render();
                window.addEventListener('monaco-ready', () => this.initMonaco());
                if (window.monaco) this.initMonaco();
            }

            render() {
                this.innerHTML = `
                <style>
                    monaco-js-editor { display: flex; flex-direction: column; overflow: hidden; background: #1e1e1e; }
                    #editor-surface { flex: 1; width: 100%; min-height: 0; background: #1e1e1e; }
                    .controls { 
                        background: #252526; padding: 8px 12px; display: flex; gap: 8px; 
                        border-bottom: 1px solid #333; align-items: center; flex-shrink: 0;
                    }
                    .controls button {
                        background: #3c3c3c; color: white; border: 1px solid #454545;
                        padding: 5px 10px; border-radius: 2px; cursor: pointer; font-size: 12px;
                    }
                    .controls button:hover { background: #4a4a4a; }
                    .controls button.primary { background: #007acc; border-color: #007acc; }
                    .controls button.ai-btn { color: #d4bfff; border-color: #8e44ad; }
                    #console {
                        height: 180px; background: #000; color: #ccc; padding: 8px;
                        font-family: 'Consolas', monospace; font-size: 11px;
                        overflow-y: auto; border-top: 1px solid #333; flex-shrink: 0;
                    }
                    .log-entry { margin-bottom: 2px; }
                    .log-entry.system { color: #666; }
                    .log-entry.ai { color: #b794f4; border-left: 2px solid #8e44ad; padding-left: 6px; margin: 4px 0; }
                    .log-entry.error { color: #f48771; }
                </style>
                <div class="controls">
                    <button id="run-btn" class="primary">â–¶ Run</button>
                    <button id="save-btn">ðŸ’¾ Save</button>
                    <button id="explain-btn" class="ai-btn">âœ¨ Explain</button>
                    <button id="fix-btn" class="ai-btn">âœ¨ Fix</button>
                    <button id="clear-btn">Clear Logs</button>
                </div>
                <div id="editor-surface"></div>
                <div id="console"><div id="log-output"></div></div>
                `;
            }

            async initMonaco() {
                if (!window.monaco || this._editor) return;
                
                this._editor = monaco.editor.create(this.querySelector('#editor-surface'), {
                    value: '',
                    language: 'javascript',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 13,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false
                });
                
                this._setupEventListeners();
                
                const files = await getAllFiles();
                if (files.length === 0) {
                    const defaultCode = `class MyCard extends HTMLElement {\n  constructor() {\n    super();\n    this.attachShadow({ mode: 'open' });\n    this.shadowRoot.innerHTML = \`<h2>Hello!</h2>\`;\n  }\n}\nconst tagName = 'my-card-' + Date.now();\ncustomElements.define(tagName, MyCard);\ndocument.body.appendChild(document.createElement(tagName));`;
                    const id = await saveFile({ name: 'main.js', content: defaultCode });
                    this.loadFile(id, 'main.js', defaultCode);
                } else {
                    this.loadFile(files[0].id, files[0].name, files[0].content);
                }
                refreshFileList();
            }

            loadFile(id, name, content) {
                this._currentFileId = id;
                this._currentFileName = name;
                this._editor.setValue(content);
                this.log(`Opened ${name}`, 'system');
                updateActiveFileUI(id);
            }

            _setupEventListeners() {
                this._editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, () => this.saveCurrent());
                this.querySelector('#run-btn').onclick = () => this.executeCode();
                this.querySelector('#save-btn').onclick = () => this.saveCurrent();
                this.querySelector('#clear-btn').onclick = () => { this.querySelector('#log-output').innerHTML = ''; };
                this.querySelector('#explain-btn').onclick = () => this.callGemini('explain');
                this.querySelector('#fix-btn').onclick = () => this.callGemini('fix');
            }

            async saveCurrent() {
                if (this._currentFileId) {
                    await saveFile({ 
                        id: this._currentFileId, 
                        name: this._currentFileName, 
                        content: this._editor.getValue() 
                    });
                    this.log(`File saved.`, 'system');
                }
            }

            async callGemini(mode) {
                const code = this._editor.getValue();
                const status = document.getElementById('ai-status');
                status.style.display = 'flex';
                this.log(`Asking Gemini...`, 'system');

                const prompts = {
                    explain: `Explain this code in 2 simple sentences:\n\n${code}`,
                    fix: `Find any bugs in this Web Component code and return ONLY the fixed JavaScript:\n\n${code}`
                };

                try {
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompts[mode] }] }] })
                    });
                    const data = await response.json();
                    const result = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (mode === 'explain') {
                        this.log(result, 'ai');
                    } else {
                        const clean = result.replace(/```javascript|```js|```/g, '').trim();
                        this._editor.setValue(clean);
                        this.log("Code updated.", "ai");
                    }
                } catch (err) {
                    this.log(`AI Error: ${err.message}`, 'error');
                } finally {
                    status.style.display = 'none';
                }
            }

            log(msg, type = '') {
                const output = this.querySelector('#log-output');
                if (!output) return;
                const div = document.createElement('div');
                div.className = `log-entry ${type}`;
                div.textContent = (type === 'ai' ? 'âœ¨ ' : '> ') + msg;
                output.appendChild(div);
                output.parentElement.scrollTop = output.parentElement.scrollHeight;
            }

            executeCode() {
                const code = this._editor.getValue();
                const frame = document.getElementById('preview-frame');
                this.log("Updating preview...", "system");
                const content = `<html><body style="padding:20px; font-family:sans-serif;"><script>
                    const log = (...args) => window.parent.postMessage({ type: 'log', data: args }, '*');
                    window.onerror = (m) => window.parent.postMessage({ type: 'error', data: m }, '*');
                    console.log = log;
                    try { ${code} } catch(e) { log('Error: ' + e.message); }
                <\/script></body></html>`;
                frame.srcdoc = content;
            }
        }

        async function refreshFileList() {
            const list = document.getElementById('file-list');
            const files = await getAllFiles();
            list.innerHTML = '';
            
            const editor = document.querySelector('monaco-js-editor');

            files.forEach(file => {
                const item = document.createElement('div');
                item.className = 'item';
                item.dataset.id = file.id;
                
                item.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    <span class="item-name">${file.name}</span>
                    <div class="item-actions">
                        <button class="action-btn rename-btn" title="Rename">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4L18.5 2.5z"></path></svg>
                        </button>
                        <button class="action-btn delete-btn" title="Delete">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                `;

                item.onclick = (e) => {
                    if (e.target.closest('.action-btn')) return;
                    editor.loadFile(file.id, file.name, file.content);
                };

                item.querySelector('.rename-btn').onclick = async () => {
                    const newName = prompt("Rename file:", file.name);
                    if (newName && newName !== file.name) {
                        file.name = newName;
                        await saveFile(file);
                        if (editor._currentFileId === file.id) {
                            editor._currentFileName = newName;
                        }
                        refreshFileList();
                    }
                };

                item.querySelector('.delete-btn').onclick = async () => {
                    if (confirm(`Delete ${file.name}?`)) {
                        await deleteFile(file.id);
                        if (editor._currentFileId === file.id) {
                            const remaining = await getAllFiles();
                            if (remaining.length > 0) {
                                editor.loadFile(remaining[0].id, remaining[0].name, remaining[0].content);
                            } else {
                                editor._currentFileId = null;
                                if (editor._editor) editor._editor.setValue('');
                            }
                        }
                        refreshFileList();
                    }
                };

                list.appendChild(item);
            });
            
            if (editor._currentFileId) updateActiveFileUI(editor._currentFileId);
        }

        function updateActiveFileUI(id) {
            document.querySelectorAll('.item').forEach(item => {
                item.classList.toggle('active', item.dataset.id == id);
            });
        }

        document.getElementById('new-file-btn').onclick = async () => {
            const name = prompt("File name:", "component.js");
            if (name) {
                const content = `// Code for ${name}`;
                const id = await saveFile({ name, content });
                await refreshFileList();
                document.querySelector('monaco-js-editor').loadFile(id, name, content);
            }
        };

        window.addEventListener('message', (e) => {
            const editor = document.querySelector('monaco-js-editor');
            if (e.data.type === 'log') editor.log(e.data.data.join(' '));
            else if (e.data.type === 'error') editor.log(e.data.data, 'error');
        });

        customElements.define('monaco-js-editor', MonacoJsEditor);
    </script>
</body>
</html>