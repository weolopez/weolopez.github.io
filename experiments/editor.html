<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Component IDE + Gemini AI</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --accent-color: #007acc;
            --ai-color: #8e44ad;
            --border-color: #333;
            --sidebar-bg: #252526;
            --hover-bg: #2a2d2e;
            --active-bg: #37373d;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        header {
            height: 48px;
            background: #252526;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            z-index: 10;
        }
        header h1 { 
            font-weight: 400; font-size: 1rem; margin: 0; 
            display: flex; align-items: center; gap: 10px; 
        }
        #ai-status {
            font-size: 11px;
            color: #aaa;
            margin-left: auto;
            display: none;
            align-items: center;
        }
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #1e1e1e;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 240px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .editor-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            min-width: 300px;
        }
        .preview-pane {
            width: 35%;
            display: flex;
            flex-direction: column;
            background: #fff;
            min-width: 250px;
        }
        #toggle-db-btn {
            margin-left: 20px; 
            background: #3c3c3c; 
            color: white; 
            border: none; 
            padding: 4px 8px; 
            cursor: pointer; 
            font-size: 11px;
        }
        .pane-header {
            background: #2d2d2d;
            padding: 4px 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: #969696;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 28px;
        }
        monaco-js-editor {
            flex: 1;
        }
        #preview-frame {
            flex: 1;
            border: none;
            background: #fdfdfd;
        }
        .spinner {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <header>
        <h1>
            <svg width="18" height="18" viewBox="0 0 100 100" fill="currentColor"><path d="M78.5 13.5L42.1 49.9l36.4 36.6 8-8-28.4-28.6 28.4-28.6-8-8zM21.5 13.5l-8 8 28.4 28.6-28.4 28.6 8 8 36.4-36.6L21.5 13.5z"/></svg>
            Component Studio
        </h1>
        <button id="toggle-db-btn">View Database</button>
        <div id="ai-status"><span class="spinner"></span> AI Analysis...</div>
    </header>
    
    <div class="main-container">
        <!-- Explorer Sidebar -->
        <div class="sidebar">
            <file-explorer></file-explorer>
        </div>

        <div class="editor-pane">
            <editor-controls></editor-controls>
            <monaco-js-editor></monaco-js-editor>
            <editor-console></editor-console>
        </div>
        <div class="preview-pane">
            <div class="pane-header">Live Preview</div>
            <iframe id="preview-frame" title="Component Preview"></iframe>
        </div>
    </div>

    <!-- Database Visualizer -->
    <database-visualizer></database-visualizer>

    <!-- Load Monaco ESM via CDN -->
    <script type="module">
        import * as monaco from 'https://cdn.jsdelivr.net/npm/monaco-editor@0.55.0/+esm';
        window.monaco = monaco;
        
        // Signal that monaco is ready
        window.dispatchEvent(new CustomEvent('monaco-ready'));
    </script>

    <script type="module">
        import './editor/wc/db-manager.js';
        import './editor/wc/monaco-editor.js';
        import './editor/wc/file-explorer.js';
        import './editor/wc/database-visualizer.js';
        import './editor/wc/editor-controls.js';
        import './editor/wc/editor-console.js';

        const editor = document.querySelector('monaco-js-editor');
        const explorer = document.querySelector('file-explorer');
        const dbVisualizer = document.querySelector('database-visualizer');
        const controls = document.querySelector('editor-controls');
        const consoleComp = document.querySelector('editor-console');

        document.getElementById('toggle-db-btn').onclick = () => {
            dbVisualizer.open();
        };

        window.addEventListener('file-opened', (e) => {
            editor.loadFile(e.detail.id, e.detail.name, e.detail.content);
        });

        window.addEventListener('file-deleted', async (e) => {
            if (editor._currentFileId === e.detail.id) {
                const { getAllFiles } = await import('./editor/wc/db-manager.js');
                const remaining = await getAllFiles();
                if (remaining.length > 0) {
                    editor.loadFile(remaining[0].id, remaining[0].name, remaining[0].content);
                } else {
                    editor._currentFileId = null;
                    if (editor._editor) editor._editor.setValue('');
                }
            }
        });

        // Wire up controls
        window.addEventListener('run-code', () => editor.executeCode());
        window.addEventListener('save-code', () => editor.saveCurrent());
        window.addEventListener('ai-explain', () => editor.callGemini('explain'));
        window.addEventListener('ai-fix', () => editor.callGemini('fix'));
        window.addEventListener('clear-logs', () => consoleComp.clear());

        // Wire up logging
        window.addEventListener('editor-log', (e) => {
            consoleComp.log(e.detail.msg, e.detail.type);
        });

        window.addEventListener('message', (e) => {
            if (e.data.type === 'log') consoleComp.log(e.data.data.join(' '));
            else if (e.data.type === 'error') consoleComp.log(e.data.data, 'error');
        });
    </script>
</body>
</html>