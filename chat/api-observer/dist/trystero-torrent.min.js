const{floor:e,random:t}=Math,r="Trystero",i=(e,t)=>Array(e).fill().map(t),n="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",s=r=>i(r,(()=>n[e(62*t())])).join(""),a=s(20),o=Promise.all.bind(Promise),h="undefined"!=typeof window,{entries:d,fromEntries:l,keys:c}=Object,u=()=>{},p=e=>Error(`${r}: ${e}`),f=new TextEncoder,_=new TextDecoder,m=e=>f.encode(e),g=e=>_.decode(e),y=(...e)=>e.join("@"),b=JSON.stringify,w=JSON.parse,S={},C="AES-GCM",v={},x=async e=>{if(v[e])return v[e];const t=Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1",m(e)))).map((e=>e.toString(36))).join("");return v[e]=t,t},E=async(e,t)=>{const r=crypto.getRandomValues(new Uint8Array(16));return r.join(",")+"$"+(i=await crypto.subtle.encrypt({name:C,iv:r},await e,m(t)),btoa(String.fromCharCode.apply(null,new Uint8Array(i))));var i},T=async(e,t)=>{const[r,i]=t.split("$");return g(await crypto.subtle.decrypt({name:C,iv:new Uint8Array(r.split(","))},await e,(e=>{const t=atob(e);return new Uint8Array(t.length).map(((e,r)=>t.charCodeAt(r))).buffer})(i)))};function k(e){return e&&e.__esModule&&{}.hasOwnProperty.call(e,"default")?e.default:e}var R,A,N,L,F,P={exports:{}};function O(){if(A)return R;A=1;var e=1e3,t=60*e,r=60*t,i=24*r,n=7*i,s=365.25*i;function a(e,t,r,i){var n=t>=1.5*r;return Math.round(e/r)+" "+i+(n?"s":"")}return R=(o,h)=>{h=h||{};var d=typeof o;if("string"===d&&o.length>0)return function(a){if((a+="").length>100)return;var o=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(!o)return;var h=parseFloat(o[1]);switch((o[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return h*s;case"weeks":case"week":case"w":return h*n;case"days":case"day":case"d":return h*i;case"hours":case"hour":case"hrs":case"hr":case"h":return h*r;case"minutes":case"minute":case"mins":case"min":case"m":return h*t;case"seconds":case"second":case"secs":case"sec":case"s":return h*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return h;default:return}}(o);if("number"===d&&isFinite(o))return h.long?function(n){var s=Math.abs(n);if(s>=i)return a(n,s,i,"day");if(s>=r)return a(n,s,r,"hour");if(s>=t)return a(n,s,t,"minute");if(s>=e)return a(n,s,e,"second");return n+" ms"}(o):function(n){var s=Math.abs(n);if(s>=i)return Math.round(n/i)+"d";if(s>=r)return Math.round(n/r)+"h";if(s>=t)return Math.round(n/t)+"m";if(s>=e)return Math.round(n/e)+"s";return n+"ms"}(o);throw Error("val is not a non-empty string or a valid number. val="+JSON.stringify(o))}}var I=(F||(F=1,function(e,t){t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const r="color: "+this.color;t.splice(1,0,r,"color: inherit");let i=0,n=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(i++,"%c"===e&&(n=i))})),t.splice(n,0,r)},t.save=e=>{try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=()=>{let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=()=>{if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=(()=>{try{return localStorage}catch(e){}})(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=(L||(L=1,N=function(e){function t(e){let i,n,s,a=null;function o(...e){if(!o.enabled)return;const r=o,n=Number(new Date),s=n-(i||n);r.diff=s,r.prev=i,r.curr=n,i=n,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((i,n)=>{if("%%"===i)return"%";a++;const s=t.formatters[n];if("function"==typeof s){const t=e[a];i=s.call(r,t),e.splice(a,1),a--}return i})),t.formatArgs.call(r,e),(r.log||t.log).apply(r,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=r,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(n!==t.namespaces&&(n=t.namespaces,s=t.enabled(e)),s),set(e){a=e}}),"function"==typeof t.init&&t.init(o),o}function r(e,r){const i=t(this.namespace+(void 0===r?":":r)+e);return i.log=this.log,i}function i(e,t){let r=0,i=0,n=-1,s=0;for(;r<e.length;)if(i<t.length&&(t[i]===e[r]||"*"===t[i]))"*"===t[i]?(n=i,s=r,i++):(r++,i++);else{if(-1===n)return!1;i=n+1,s++,r=s}for(;i<t.length&&"*"===t[i];)i++;return i===t.length}return t.debug=t,t.default=t,t.coerce=e=>e instanceof Error?e.stack||e.message:e,t.disable=()=>{const e=[...t.names,...t.skips.map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=e=>{t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"==typeof e?e:"").trim().replace(" ",",").split(",").filter(Boolean);for(const e of r)"-"===e[0]?t.skips.push(e.slice(1)):t.names.push(e)},t.enabled=e=>{for(const r of t.skips)if(i(e,r))return!1;for(const r of t.names)if(i(e,r))return!0;return!1},t.humanize=O(),t.destroy=()=>{console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((r=>{t[r]=e[r]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=e=>{let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t),r|=0;return t.colors[Math.abs(r)%t.colors.length]},t.enable(t.load()),t}),N)(t);const{formatters:r}=e.exports;r.j=e=>{try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}}(P,P.exports)),P.exports),D=k(I);const M="undefined"!=typeof window?window:self,j=M.RTCPeerConnection||M.mozRTCPeerConnection||M.webkitRTCPeerConnection,U=M.RTCSessionDescription||M.mozRTCSessionDescription||M.webkitRTCSessionDescription,q=M.RTCIceCandidate||M.mozRTCIceCandidate||M.webkitRTCIceCandidate;var W,$,B,H,Y,z,J,K,G,V,Z,X={exports:{}};function Q(){if(W)return X.exports;W=1;var e,t="object"==typeof Reflect?Reflect:null,r=t&&"function"==typeof t.apply?t.apply:function(e,t,r){return function(){}.apply.call(e,t,r)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}X.exports=n,X.exports.once=function(e,t){return new Promise(((r,i)=>{function n(r){e.removeListener(t,s),i(r)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",n),r([].slice.call(arguments))}f(e,t,s,{once:!0}),"error"!==t&&function(e,t,r){"function"==typeof e.on&&f(e,"error",t,r)}(e,n,{once:!0})}))},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var s=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function o(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function h(e,t,r,i){var n,s,h,d;if(a(r),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),h=s[t]),void 0===h)h=s[t]=r,++e._eventsCount;else if("function"==typeof h?h=s[t]=i?[r,h]:[h,r]:i?h.unshift(r):h.push(r),(n=o(e))>0&&h.length>n&&!h.warned){h.warned=!0;var l=Error("Possible EventEmitter memory leak detected. "+h.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=h.length,d=l,console&&console.warn&&console.warn(d)}return e}function d(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(e,t,r){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},n=d.bind(i);return n.listener=r,i.wrapFn=n,n}function c(e,t,r){var i=e._events;if(void 0===i)return[];var n=i[t];return void 0===n?[]:"function"==typeof n?r?[n.listener||n]:[n]:r?function(e){for(var t=Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(n):p(n,n.length)}function u(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function p(e,t){for(var r=Array(t),i=0;i<t;++i)r[i]=e[i];return r}function f(e,t,r,i){if("function"==typeof e.on)i.once?e.once(t,r):e.on(t,r);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function n(s){i.once&&e.removeEventListener(t,n),r(s)}))}}return Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get(){return s},set(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");s=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return o(this)},n.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,s=this._events;if(void 0!==s)n=n&&void 0===s.error;else if(!n)return!1;if(n){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var h=s[e];if(void 0===h)return!1;if("function"==typeof h)r(h,this,t);else{var d=h.length,l=p(h,d);for(i=0;i<d;++i)r(l[i],this,t)}return!0},n.prototype.addListener=function(e,t){return h(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return h(this,e,t,!0)},n.prototype.once=function(e,t){return a(t),this.on(e,l(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,l(this,e,t)),this},n.prototype.removeListener=function(e,t){var r,i,n,s,o;if(a(t),void 0===(i=this._events))return this;if(void 0===(r=i[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(n=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){o=r[s].listener,n=s;break}if(n<0)return this;0===n?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,n),1===r.length&&(i[e]=r[0]),void 0!==i.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,r,i;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var n,s=Object.keys(r);for(i=0;i<s.length;++i)"removeListener"!==(n=s[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},n.prototype.listeners=function(e){return c(this,e,!0)},n.prototype.rawListeners=function(e){return c(this,e,!1)},n.listenerCount=(e,t)=>"function"==typeof e.listenerCount?e.listenerCount(t):u.call(e,t),n.prototype.listenerCount=u,n.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},X.exports}function ee(){if(Y)return H;Y=1;const e=B?$:(B=1,$=class{constructor(e){if(!(e>0)||e-1&e)throw Error("Max size for a FixedFIFO should be a power of two");this.buffer=Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}clear(){this.top=this.btm=0,this.next=null,this.buffer.fill(void 0)}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}peek(){return this.buffer[this.btm]}isEmpty(){return void 0===this.buffer[this.btm]}});return H=class{constructor(t){this.hwm=t||16,this.head=new e(this.hwm),this.tail=this.head,this.length=0}clear(){this.head=this.tail,this.head.clear(),this.length=0}push(t){if(this.length++,!this.head.push(t)){const r=this.head;this.head=r.next=new e(2*this.head.buffer.length),this.head.push(t)}}shift(){0!==this.length&&this.length--;const e=this.tail.shift();if(void 0===e&&this.tail.next){const e=this.tail.next;return this.tail.next=null,this.tail=e,this.tail.shift()}return e}peek(){const e=this.tail.peek();return void 0===e&&this.tail.next?this.tail.next.peek():e}isEmpty(){return 0===this.length}}}function te(){return J?z:(J=1,z=class{constructor(e){this.decoder=new TextDecoder("utf16le"===e?"utf16-le":e)}get remaining(){return-1}decode(e){return this.decoder.decode(e,{stream:!0})}flush(){return this.decoder.decode(new Uint8Array(0))}})}function re(){if(G)return K;G=1;const e=te(),t=te();return K=class{constructor(r="utf8"){switch(this.encoding=function(e){switch(e=e.toLowerCase()){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return e;default:throw Error("Unknown encoding: "+e)}}(r),this.encoding){case"utf8":this.decoder=new t;break;case"utf16le":case"base64":throw Error("Unsupported encoding: "+this.encoding);default:this.decoder=new e(this.encoding)}}get remaining(){return this.decoder.remaining}push(e){return"string"==typeof e?e:this.decoder.decode(e)}write(e){return this.push(e)}end(e){let t="";return e&&(t=this.push(e)),t+=this.decoder.flush(),t}}}var ie,ne,se=function(){if(Z)return V;Z=1;const{EventEmitter:e}=Q(),t=Error("Stream was destroyed"),r=Error("Premature close"),i=ee(),n=re(),s=536870911,a=1^s,o=2^s,h=32,d=64,l=128,c=256,u=1024,p=2048,f=4096,_=8192,m=16384,g=32768,y=131072,b=131328,w=16^s,S=536805375,C=768^s,v=536838143,x=536739839,E=1<<18,T=2<<18,k=4<<18,R=8<<18,A=16<<18,N=32<<18,L=64<<18,F=128<<18,P=256<<18,O=512<<18,I=1024<<18,D=535822335,M=503316479,j=268435455,U=262160,q=536608751,W=8404992,$=14,B=15,H=8405006,Y=33587200,z=33587215,J=2359296,K=270794767,G=Symbol.asyncIterator||Symbol();class X{constructor(e,{highWaterMark:t=16384,map:r=null,mapWritable:n,byteLength:s,byteLengthWritable:a}={}){this.stream=e,this.queue=new i,this.highWaterMark=t,this.buffered=0,this.error=null,this.pipeline=null,this.drains=null,this.byteLength=a||s||Ee,this.map=n||r,this.afterWrite=he.bind(this),this.afterUpdateNextTick=ce.bind(this)}get ended(){return!!(this.stream._duplexState&N)}push(e){return!(142606350&this.stream._duplexState)&&(null!==this.map&&(e=this.map(e)),this.buffered+=this.byteLength(e),this.queue.push(e),this.buffered<this.highWaterMark?(this.stream._duplexState|=R,!0):(this.stream._duplexState|=6291456,!1))}shift(){const e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=534773759),e}end(e){"function"==typeof e?this.stream.once("finish",e):null!=e&&this.push(e),this.stream._duplexState=(this.stream._duplexState|O)&D}autoBatch(e,t){const r=[],i=this.stream;for(r.push(e);(i._duplexState&K)===J;)r.push(i._writableState.shift());if(i._duplexState&B)return t(null);i._writev(r,t)}update(){const e=this.stream;e._duplexState|=T;do{for(;(e._duplexState&K)===R;){const t=this.shift();e._duplexState|=67371008,e._write(t,this.afterWrite)}1310720&e._duplexState||this.updateNonPrimary()}while(!0===this.continueUpdate());e._duplexState&=536346623}updateNonPrimary(){const e=this.stream;if((144965647&e._duplexState)===O)return e._duplexState=e._duplexState|E,void e._final(ae.bind(this));4!=(e._duplexState&$)?1==(e._duplexState&z)&&(e._duplexState=(e._duplexState|U)&a,e._open(ue.bind(this))):e._duplexState&Y||(e._duplexState|=U,e._destroy(oe.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&F)&&(this.stream._duplexState&=M,!0)}updateCallback(){(35127311&this.stream._duplexState)===k?this.update():this.updateNextTick()}updateNextTick(){this.stream._duplexState&F||(this.stream._duplexState|=F,this.stream._duplexState&T||queueMicrotask(this.afterUpdateNextTick))}}class te{constructor(e,{highWaterMark:t=16384,map:r=null,mapReadable:n,byteLength:s,byteLengthReadable:a}={}){this.stream=e,this.queue=new i,this.highWaterMark=0===t?1:t,this.buffered=0,this.readAhead=t>0,this.error=null,this.pipeline=null,this.byteLength=a||s||Ee,this.map=n||r,this.pipeTo=null,this.afterRead=de.bind(this),this.afterUpdateNextTick=le.bind(this)}get ended(){return!!(this.stream._duplexState&m)}pipe(e,t){if(null!==this.pipeTo)throw Error("Can only pipe to one destination");if("function"!=typeof t&&(t=null),this.stream._duplexState|=512,this.pipeTo=e,this.pipeline=new ne(this.stream,e,t),t&&this.stream.on("error",Te),xe(e))e._writableState.pipeline=this.pipeline,t&&e.on("error",Te),e.on("finish",this.pipeline.finished.bind(this.pipeline));else{const t=this.pipeline.done.bind(this.pipeline,e),r=this.pipeline.done.bind(this.pipeline,e,null);e.on("error",t),e.on("close",r),e.on("finish",this.pipeline.finished.bind(this.pipeline))}e.on("drain",se.bind(this)),this.stream.emit("piping",e),e.emit("pipe",this.stream)}push(e){const t=this.stream;return null===e?(this.highWaterMark=0,t._duplexState=536805311&t._duplexState|1024,!1):null!==this.map&&null===(e=this.map(e))?(t._duplexState&=S,this.buffered<this.highWaterMark):(this.buffered+=this.byteLength(e),this.queue.push(e),t._duplexState=(t._duplexState|l)&S,this.buffered<this.highWaterMark)}shift(){const e=this.queue.shift();return this.buffered-=this.byteLength(e),0===this.buffered&&(this.stream._duplexState&=536862591),e}unshift(e){const t=[null!==this.map?this.map(e):e];for(;this.buffered>0;)t.push(this.shift());for(let e=0;e<t.length-1;e++){const r=t[e];this.buffered+=this.byteLength(r),this.queue.push(r)}this.push(t[t.length-1])}read(){const e=this.stream;if((16527&e._duplexState)===l){const t=this.shift();return null!==this.pipeTo&&!1===this.pipeTo.write(t)&&(e._duplexState&=C),e._duplexState&p&&e.emit("data",t),t}return!1===this.readAhead&&(e._duplexState|=y,this.updateNextTick()),null}drain(){const e=this.stream;for(;(16527&e._duplexState)===l&&768&e._duplexState;){const t=this.shift();null!==this.pipeTo&&!1===this.pipeTo.write(t)&&(e._duplexState&=C),e._duplexState&p&&e.emit("data",t)}}update(){const e=this.stream;e._duplexState|=h;do{for(this.drain();this.buffered<this.highWaterMark&&(214047&e._duplexState)===y;)e._duplexState|=65552,e._read(this.afterRead),this.drain();4224==(12431&e._duplexState)&&(e._duplexState|=_,e.emit("readable")),80&e._duplexState||this.updateNonPrimary()}while(!0===this.continueUpdate());e._duplexState&=536870879}updateNonPrimary(){const e=this.stream;(1167&e._duplexState)===u&&(e._duplexState=536869887&e._duplexState|16384,e.emit("end"),(e._duplexState&H)===W&&(e._duplexState|=4),null!==this.pipeTo&&this.pipeTo.end()),4!=(e._duplexState&$)?1==(e._duplexState&z)&&(e._duplexState=(e._duplexState|U)&a,e._open(ue.bind(this))):e._duplexState&Y||(e._duplexState|=U,e._destroy(oe.bind(this)))}continueUpdate(){return!!(this.stream._duplexState&g)&&(this.stream._duplexState&=v,!0)}updateCallback(){(32879&this.stream._duplexState)===d?this.update():this.updateNextTick()}updateNextTickIfOpen(){32769&this.stream._duplexState||(this.stream._duplexState|=g,this.stream._duplexState&h||queueMicrotask(this.afterUpdateNextTick))}updateNextTick(){this.stream._duplexState&g||(this.stream._duplexState|=g,this.stream._duplexState&h||queueMicrotask(this.afterUpdateNextTick))}}class ie{constructor(e){this.data=null,this.afterTransform=pe.bind(e),this.afterFinal=null}}class ne{constructor(e,t,r){this.from=e,this.to=t,this.afterPipe=r,this.error=null,this.pipeToFinished=!1}finished(){this.pipeToFinished=!0}done(e,t){t&&(this.error=t),e!==this.to||(this.to=null,null===this.from)?e!==this.from||(this.from=null,null===this.to)?(null!==this.afterPipe&&this.afterPipe(this.error),this.to=this.from=this.afterPipe=null):e._duplexState&m||this.to.destroy(this.error||Error("Readable stream closed before ending")):this.from._duplexState&m&&this.pipeToFinished||this.from.destroy(this.error||Error("Writable stream closed prematurely"))}}function se(){this.stream._duplexState|=512,this.updateCallback()}function ae(e){const t=this.stream;e&&t.destroy(e),t._duplexState&$||(t._duplexState|=N,t.emit("finish")),(t._duplexState&H)===W&&(t._duplexState|=4),t._duplexState&=402391039,t._duplexState&T?this.updateNextTick():this.update()}function oe(e){const r=this.stream;e||this.error===t||(e=this.error),e&&r.emit("error",e),r._duplexState|=8,r.emit("close");const i=r._readableState,n=r._writableState;if(null!==i&&null!==i.pipeline&&i.pipeline.done(r,e),null!==n){for(;null!==n.drains&&n.drains.length>0;)n.drains.shift().resolve(!1);null!==n.pipeline&&n.pipeline.done(r,e)}}function he(e){const t=this.stream;e&&t.destroy(e),t._duplexState&=469499903,null!==this.drains&&function(e){for(let t=0;t<e.length;t++)0==--e[t].writes&&(e.shift().resolve(!0),t--)}(this.drains),(6553615&t._duplexState)===A&&(t._duplexState&=532676607,(t._duplexState&L)===L&&t.emit("drain")),this.updateCallback()}function de(e){e&&this.stream.destroy(e),this.stream._duplexState&=w,!1!==this.readAhead||this.stream._duplexState&c||(this.stream._duplexState&=x),this.updateCallback()}function le(){this.stream._duplexState&h||(this.stream._duplexState&=v,this.update())}function ce(){this.stream._duplexState&T||(this.stream._duplexState&=M,this.update())}function ue(e){const t=this.stream;e&&t.destroy(e),4&t._duplexState||(17423&t._duplexState||(t._duplexState|=d),142606351&t._duplexState||(t._duplexState|=k),t.emit("open")),t._duplexState&=q,null!==t._writableState&&t._writableState.updateCallback(),null!==t._readableState&&t._readableState.updateCallback()}function pe(e,t){null!=t&&this.push(t),this._writableState.afterWrite(e)}function fe(e){null!==this._readableState&&("data"===e&&(this._duplexState|=133376,this._readableState.updateNextTick()),"readable"===e&&(this._duplexState|=f,this._readableState.updateNextTick())),null!==this._writableState&&"drain"===e&&(this._duplexState|=L,this._writableState.updateNextTick())}class _e extends e{constructor(e){super(),this._duplexState=0,this._readableState=null,this._writableState=null,e&&(e.open&&(this._open=e.open),e.destroy&&(this._destroy=e.destroy),e.predestroy&&(this._predestroy=e.predestroy),e.signal&&e.signal.addEventListener("abort",ke.bind(this))),this.on("newListener",fe)}_open(e){e(null)}_destroy(e){e(null)}_predestroy(){}get readable(){return null!==this._readableState||void 0}get writable(){return null!==this._writableState||void 0}get destroyed(){return!!(8&this._duplexState)}get destroying(){return!!(this._duplexState&$)}destroy(e){this._duplexState&$||(e||(e=t),this._duplexState=535822271&this._duplexState|4,null!==this._readableState&&(this._readableState.highWaterMark=0,this._readableState.error=e),null!==this._writableState&&(this._writableState.highWaterMark=0,this._writableState.error=e),this._duplexState|=2,this._predestroy(),this._duplexState&=o,null!==this._readableState&&this._readableState.updateNextTick(),null!==this._writableState&&this._writableState.updateNextTick())}}class me extends _e{constructor(e){super(e),this._duplexState|=8519681,this._readableState=new te(this,e),e&&(!1===this._readableState.readAhead&&(this._duplexState&=x),e.read&&(this._read=e.read),e.eagerOpen&&this._readableState.updateNextTick(),e.encoding&&this.setEncoding(e.encoding))}setEncoding(e){const t=new n(e),r=this._readableState.map||Ce;return this._readableState.map=function(e){const i=t.push(e);return""===i&&(0!==e.byteLength||t.remaining>0)?null:r(i)},this}_read(e){e(null)}pipe(e,t){return this._readableState.updateNextTick(),this._readableState.pipe(e,t),e}read(){return this._readableState.updateNextTick(),this._readableState.read()}push(e){return this._readableState.updateNextTickIfOpen(),this._readableState.push(e)}unshift(e){return this._readableState.updateNextTickIfOpen(),this._readableState.unshift(e)}resume(){return this._duplexState|=b,this._readableState.updateNextTick(),this}pause(){return this._duplexState&=!1===this._readableState.readAhead?536739583:536870655,this}static _fromAsyncIterator(e,t){let r;const i=new me({...t,read(t){e.next().then(n).then(t.bind(null,null)).catch(t)},predestroy(){r=e.return()},destroy(e){if(!r)return e(null);r.then(e.bind(null,null)).catch(e)}});return i;function n(e){e.done?i.push(null):i.push(e.value)}}static from(e,t){if(xe(r=e)&&r.readable)return e;var r;if(e[G])return this._fromAsyncIterator(e[G](),t);Array.isArray(e)||(e=void 0===e?[]:[e]);let i=0;return new me({...t,read(t){this.push(i===e.length?null:e[i++]),t(null)}})}static isBackpressured(e){return!!(17422&e._duplexState)||e._readableState.buffered>=e._readableState.highWaterMark}static isPaused(e){return!(e._duplexState&c)}[G](){const e=this;let r=null,i=null,n=null;return this.on("error",(e=>{r=e})),this.on("readable",(function(){null!==i&&s(e.read())})),this.on("close",(function(){null!==i&&s(null)})),{[G](){return this},next:()=>new Promise(((t,r)=>{i=t,n=r;const a=e.read();null!==a?s(a):8&e._duplexState&&s(null)})),return:()=>a(null),throw:e=>a(e)};function s(s){null!==n&&(r?n(r):null!==s||e._duplexState&m?i({value:s,done:null===s}):n(t),n=i=null)}function a(t){return e.destroy(t),new Promise(((r,i)=>{if(8&e._duplexState)return r({value:void 0,done:!0});e.once("close",(()=>{t?i(t):r({value:void 0,done:!0})}))}))}}}class ge extends _e{constructor(e){super(e),this._duplexState|=16385,this._writableState=new X(this,e),e&&(e.writev&&(this._writev=e.writev),e.write&&(this._write=e.write),e.final&&(this._final=e.final),e.eagerOpen&&this._writableState.updateNextTick())}cork(){this._duplexState|=I}uncork(){this._duplexState&=j,this._writableState.updateNextTick()}_writev(e,t){t(null)}_write(e,t){this._writableState.autoBatch(e,t)}_final(e){e(null)}static isBackpressured(e){return!!(146800654&e._duplexState)}static drained(e){if(e.destroyed)return Promise.resolve(!1);const t=e._writableState;var r;const i=((r=e)._writev!==ge.prototype._writev&&r._writev!==ye.prototype._writev?Math.min(1,t.queue.length):t.queue.length)+(e._duplexState&P?1:0);return 0===i?Promise.resolve(!0):(null===t.drains&&(t.drains=[]),new Promise((e=>{t.drains.push({writes:i,resolve:e})})))}write(e){return this._writableState.updateNextTick(),this._writableState.push(e)}end(e){return this._writableState.updateNextTick(),this._writableState.end(e),this}}class ye extends me{constructor(e){super(e),this._duplexState=1|this._duplexState&y,this._writableState=new X(this,e),e&&(e.writev&&(this._writev=e.writev),e.write&&(this._write=e.write),e.final&&(this._final=e.final))}cork(){this._duplexState|=I}uncork(){this._duplexState&=j,this._writableState.updateNextTick()}_writev(e,t){t(null)}_write(e,t){this._writableState.autoBatch(e,t)}_final(e){e(null)}write(e){return this._writableState.updateNextTick(),this._writableState.push(e)}end(e){return this._writableState.updateNextTick(),this._writableState.end(e),this}}class be extends ye{constructor(e){super(e),this._transformState=new ie(this),e&&(e.transform&&(this._transform=e.transform),e.flush&&(this._flush=e.flush))}_write(e,t){this._readableState.buffered>=this._readableState.highWaterMark?this._transformState.data=e:this._transform(e,this._transformState.afterTransform)}_read(e){if(null!==this._transformState.data){const t=this._transformState.data;this._transformState.data=null,e(null),this._transform(t,this._transformState.afterTransform)}else e(null)}destroy(e){super.destroy(e),null!==this._transformState.data&&(this._transformState.data=null,this._transformState.afterTransform())}_transform(e,t){t(null,e)}_flush(e){e(null)}_final(e){this._transformState.afterFinal=e,this._flush(we.bind(this))}}function we(e,t){const r=this._transformState.afterFinal;if(e)return r(e);null!=t&&this.push(t),this.push(null),r(null)}function Se(e,...t){const i=Array.isArray(e)?[...e,...t]:[e,...t],n=i.length&&"function"==typeof i[i.length-1]?i.pop():null;if(i.length<2)throw Error("Pipeline requires at least 2 streams");let s=i[0],a=null,o=null;for(let e=1;e<i.length;e++)a=i[e],xe(s)?s.pipe(a,d):(h(s,!0,e>1,d),s.pipe(a)),s=a;if(n){let e=!1;const t=xe(a)||!(!a._writableState||!a._writableState.autoDestroy);a.on("error",(e=>{null===o&&(o=e)})),a.on("finish",(()=>{e=!0,t||n(o)})),t&&a.on("close",(()=>n(o||(e?null:r))))}return a;function h(e,t,i,n){e.on("error",n),e.on("close",(function(){if(e._readableState&&!e._readableState.ended)return n(r);if(i&&e._writableState&&!e._writableState.ended)return n(r)}))}function d(e){if(e&&!o){o=e;for(const t of i)t.destroy(e)}}}function Ce(e){return e}function ve(e){return!!e._readableState||!!e._writableState}function xe(e){return"number"==typeof e._duplexState&&ve(e)}function Ee(e){return function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.byteLength}(e)?e.byteLength:1024}function Te(){}function ke(){this.destroy(Error("Stream aborted."))}return V={pipeline:Se,pipelinePromise(...e){return new Promise(((t,r)=>Se(...e,(e=>{if(e)return r(e);t()}))))},isStream:ve,isStreamx:xe,isEnded(e){return!!e._readableState&&e._readableState.ended},isFinished(e){return!!e._writableState&&e._writableState.ended},isDisturbed(e){return!!(1&~e._duplexState)||!!(e._duplexState&Y)},getStreamError(e,r={}){const i=e._readableState&&e._readableState.error||e._writableState&&e._writableState.error;return r.all||i!==t?i:null},Stream:_e,Writable:ge,Readable:me,Duplex:ye,Transform:be,PassThrough:class extends be{}}}();var ae=k(function(){if(ne)return ie;function e(e,t){for(const r in t)Object.defineProperty(e,r,{value:t[r],enumerable:!0,configurable:!0});return e}return ne=1,ie=function(t,r,i){if(!t||"string"==typeof t)throw new TypeError("Please pass an Error to err-code");i||(i={}),"object"==typeof r&&(i=r,r=""),r&&(i.code=r);try{return e(t,i)}catch(r){i.message=t.message,i.stack=t.stack;const n=()=>{};n.prototype=Object.create(Object.getPrototypeOf(t));return e(new n,i)}}}());const oe="0123456789abcdef",he=[];for(let e=0;e<256;e++)he[e]=oe[e>>4&15]+oe[15&e];const de=e=>{const t=e.length;let r="",i=0;for(;i<t;)r+=he[e[i++]];return r};for(var le="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ce="undefined"==typeof Uint8Array?[]:new Uint8Array(256),ue=0;ue<64;ue++)ce[le.charCodeAt(ue)]=ue;new TextDecoder;const pe=new TextEncoder,fe="undefined"!=typeof window?window:self,_e=fe.crypto||fe.msCrypto||{};_e.subtle||_e.webkitSubtle;const me=e=>{const t=new Uint8Array(e);return _e.getRandomValues(t)},ge=D("simple-peer"),ye=65536;function be(e){return e.replace(/a=ice-options:trickle\s\n/g,"")}let we=class e extends se.Duplex{_pc;constructor(t){if(super(t=Object.assign({allowHalfOpen:!1},t)),this.__objectMode=!!t.objectMode,this._id=de(me(4)).slice(0,7),this._debug("new peer %o",t),this.channelName=t.initiator?t.channelName||de(me(20)):null,this.initiator=t.initiator||!1,this.channelConfig=t.channelConfig||e.channelConfig,this.channelNegotiated=this.channelConfig.negotiated,this.config=Object.assign({},e.config,t.config),this.offerOptions=t.offerOptions||{},this.answerOptions=t.answerOptions||{},this.sdpTransform=t.sdpTransform||(e=>e),this.trickle=void 0===t.trickle||t.trickle,this.allowHalfTrickle=void 0!==t.allowHalfTrickle&&t.allowHalfTrickle,this.iceCompleteTimeout=t.iceCompleteTimeout||5e3,this._destroying=!1,this._connected=!1,this.remoteAddress=void 0,this.remoteFamily=void 0,this.remotePort=void 0,this.localAddress=void 0,this.localFamily=void 0,this.localPort=void 0,!j)throw"undefined"==typeof window?ae(Error("No WebRTC support: Specify `opts.wrtc` option in this environment"),"ERR_WEBRTC_SUPPORT"):ae(Error("No WebRTC support: Not a supported browser"),"ERR_WEBRTC_SUPPORT");this._pcReady=!1,this._channelReady=!1,this._iceComplete=!1,this._iceCompleteTimer=null,this._channel=null,this._pendingCandidates=[],this._isNegotiating=!1,this._firstNegotiation=!0,this._batchedNegotiation=!1,this._queuedNegotiation=!1,this._sendersAwaitingStable=[],this._closingInterval=null,this._remoteTracks=[],this._remoteStreams=[],this._chunk=null,this._cb=null,this._interval=null;try{this._pc=new j(this.config)}catch(e){return void this.__destroy(ae(e,"ERR_PC_CONSTRUCTOR"))}this._isReactNativeWebrtc="number"==typeof this._pc._peerConnectionId,this._pc.oniceconnectionstatechange=()=>{this._onIceStateChange()},this._pc.onicegatheringstatechange=()=>{this._onIceStateChange()},this._pc.onconnectionstatechange=()=>{this._onConnectionStateChange()},this._pc.onsignalingstatechange=()=>{this._onSignalingStateChange()},this._pc.onicecandidate=e=>{this._onIceCandidate(e)},"object"==typeof this._pc.peerIdentity&&this._pc.peerIdentity.catch((e=>{this.__destroy(ae(e,"ERR_PC_PEER_IDENTITY"))})),this.initiator||this.channelNegotiated?this._setupData({channel:this._pc.createDataChannel(this.channelName,this.channelConfig)}):this._pc.ondatachannel=e=>{this._setupData(e)},this._debug("initial negotiation"),this._needsNegotiation(),this._onFinishBound=()=>{this._onFinish()},this.once("finish",this._onFinishBound)}get bufferSize(){return this._channel&&this._channel.bufferedAmount||0}get connected(){return this._connected&&"open"===this._channel.readyState}address(){return{port:this.localPort,family:this.localFamily,address:this.localAddress}}signal(e){if(!this._destroying){if(this.destroyed)throw ae(Error("cannot signal after peer is destroyed"),"ERR_DESTROYED");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}this._debug("signal()"),e.renegotiate&&this.initiator&&(this._debug("got request to renegotiate"),this._needsNegotiation()),e.transceiverRequest&&this.initiator&&(this._debug("got request for transceiver"),this.addTransceiver(e.transceiverRequest.kind,e.transceiverRequest.init)),e.candidate&&(this._pc.remoteDescription&&this._pc.remoteDescription.type?this._addIceCandidate(e.candidate):this._pendingCandidates.push(e.candidate)),e.sdp&&this._pc.setRemoteDescription(new U(e)).then((()=>{this.destroyed||(this._pendingCandidates.forEach((e=>{this._addIceCandidate(e)})),this._pendingCandidates=[],"offer"===this._pc.remoteDescription.type&&this._createAnswer())})).catch((e=>{this.__destroy(ae(e,"ERR_SET_REMOTE_DESCRIPTION"))})),e.sdp||e.candidate||e.renegotiate||e.transceiverRequest||this.__destroy(ae(Error("signal() called with invalid signal data"),"ERR_SIGNALING"))}}_addIceCandidate(e){const t=new q(e);this._pc.addIceCandidate(t).catch((e=>{!t.address||t.address.endsWith(".local")?console.warn("Ignoring unsupported ICE candidate."):this.__destroy(ae(e,"ERR_ADD_ICE_CANDIDATE"))}))}send(e){if(!this._destroying){if(this.destroyed)throw ae(Error("cannot send after peer is destroyed"),"ERR_DESTROYED");this._channel.send(e)}}_needsNegotiation(){this._debug("_needsNegotiation"),this._batchedNegotiation||(this._batchedNegotiation=!0,queueMicrotask((()=>{this._batchedNegotiation=!1,this.initiator||!this._firstNegotiation?(this._debug("starting batched negotiation"),this.negotiate()):this._debug("non-initiator initial negotiation request discarded"),this._firstNegotiation=!1})))}negotiate(){if(!this._destroying){if(this.destroyed)throw ae(Error("cannot negotiate after peer is destroyed"),"ERR_DESTROYED");this.initiator?this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("start negotiation"),setTimeout((()=>{this._createOffer()}),0)):this._isNegotiating?(this._queuedNegotiation=!0,this._debug("already negotiating, queueing")):(this._debug("requesting negotiation from initiator"),this.emit("signal",{type:"renegotiate",renegotiate:!0})),this._isNegotiating=!0}}_final(e){this._readableState.ended||this.push(null),e(null)}__destroy(e){this.end(),this._destroy((()=>{}),e)}_destroy(e,t){this.destroyed||this._destroying||(this._destroying=!0,this._debug("destroying (error: %s)",t&&(t.message||t)),setTimeout((()=>{if(this._connected=!1,this._pcReady=!1,this._channelReady=!1,this._remoteTracks=null,this._remoteStreams=null,this._senderMap=null,clearInterval(this._closingInterval),this._closingInterval=null,clearInterval(this._interval),this._interval=null,this._chunk=null,this._cb=null,this._onFinishBound&&this.removeListener("finish",this._onFinishBound),this._onFinishBound=null,this._channel){try{this._channel.close()}catch(e){}this._channel.onmessage=null,this._channel.onopen=null,this._channel.onclose=null,this._channel.onerror=null}if(this._pc){try{this._pc.close()}catch(e){}this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.ondatachannel=null}this._pc=null,this._channel=null,t&&this.emit("error",t),e()}),0))}_setupData(e){if(!e.channel)return this.__destroy(ae(Error("Data channel event is missing `channel` property"),"ERR_DATA_CHANNEL"));this._channel=e.channel,this._channel.binaryType="arraybuffer","number"==typeof this._channel.bufferedAmountLowThreshold&&(this._channel.bufferedAmountLowThreshold=ye),this.channelName=this._channel.label,this._channel.onmessage=e=>{this._onChannelMessage(e)},this._channel.onbufferedamountlow=()=>{this._onChannelBufferedAmountLow()},this._channel.onopen=()=>{this._onChannelOpen()},this._channel.onclose=()=>{this._onChannelClose()},this._channel.onerror=e=>{const t=e.error instanceof Error?e.error:Error(`Datachannel error: ${e.message} ${e.filename}:${e.lineno}:${e.colno}`);this.__destroy(ae(t,"ERR_DATA_CHANNEL"))};let t=!1;this._closingInterval=setInterval((()=>{this._channel&&"closing"===this._channel.readyState?(t&&this._onChannelClose(),t=!0):t=!1}),5e3)}_write(e,t){if(this.destroyed)return t(ae(Error("cannot write after peer is destroyed"),"ERR_DATA_CHANNEL"));if(this._connected){try{this.send(e)}catch(e){return this.__destroy(ae(e,"ERR_DATA_CHANNEL"))}this._channel.bufferedAmount>ye?(this._debug("start backpressure: bufferedAmount %d",this._channel.bufferedAmount),this._cb=t):t(null)}else this._debug("write before connect"),this._chunk=e,this._cb=t}_onFinish(){if(this.destroyed)return;const e=()=>{setTimeout((()=>this.__destroy()),1e3)};this._connected?e():this.once("connect",e)}_startIceCompleteTimeout(){this.destroyed||this._iceCompleteTimer||(this._debug("started iceComplete timeout"),this._iceCompleteTimer=setTimeout((()=>{this._iceComplete||(this._iceComplete=!0,this._debug("iceComplete timeout completed"),this.emit("iceTimeout"),this.emit("_iceComplete"))}),this.iceCompleteTimeout))}_createOffer(){this.destroyed||this._pc.createOffer(this.offerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=be(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp})};this._pc.setLocalDescription(e).then((()=>{this._debug("createOffer success"),this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.__destroy(ae(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.__destroy(ae(e,"ERR_CREATE_OFFER"))}))}_createAnswer(){this.destroyed||this._pc.createAnswer(this.answerOptions).then((e=>{if(this.destroyed)return;this.trickle||this.allowHalfTrickle||(e.sdp=be(e.sdp)),e.sdp=this.sdpTransform(e.sdp);const t=()=>{if(this.destroyed)return;const t=this._pc.localDescription||e;this._debug("signal"),this.emit("signal",{type:t.type,sdp:t.sdp}),this.initiator||this._requestMissingTransceivers?.()};this._pc.setLocalDescription(e).then((()=>{this.destroyed||(this.trickle||this._iceComplete?t():this.once("_iceComplete",t))})).catch((e=>{this.__destroy(ae(e,"ERR_SET_LOCAL_DESCRIPTION"))}))})).catch((e=>{this.__destroy(ae(e,"ERR_CREATE_ANSWER"))}))}_onConnectionStateChange(){this.destroyed||this._destroying||"failed"===this._pc.connectionState&&this.__destroy(ae(Error("Connection failed."),"ERR_CONNECTION_FAILURE"))}_onIceStateChange(){if(this.destroyed)return;const e=this._pc.iceConnectionState,t=this._pc.iceGatheringState;this._debug("iceStateChange (connection: %s) (gathering: %s)",e,t),this.emit("iceStateChange",e,t),"connected"!==e&&"completed"!==e||(this._pcReady=!0,this._maybeReady()),"failed"===e&&this.__destroy(ae(Error("Ice connection failed."),"ERR_ICE_CONNECTION_FAILURE")),"closed"===e&&this.__destroy(ae(Error("Ice connection closed."),"ERR_ICE_CONNECTION_CLOSED"))}getStats(e){const t=e=>("[object Array]"==={}.toString.call(e.values)&&e.values.forEach((t=>{Object.assign(e,t)})),e);0===this._pc.getStats.length||this._isReactNativeWebrtc?this._pc.getStats().then((r=>{const i=[];r.forEach((e=>{i.push(t(e))})),e(null,i)}),(t=>e(t))):this._pc.getStats.length>0?this._pc.getStats((r=>{if(this.destroyed)return;const i=[];r.result().forEach((e=>{const r={};e.names().forEach((t=>{r[t]=e.stat(t)})),r.id=e.id,r.type=e.type,r.timestamp=e.timestamp,i.push(t(r))})),e(null,i)}),(t=>e(t))):e(null,[])}_maybeReady(){if(this._debug("maybeReady pc %s channel %s",this._pcReady,this._channelReady),this._connected||this._connecting||!this._pcReady||!this._channelReady)return;this._connecting=!0;const e=()=>{this.destroyed||this._destroying||this.getStats(((t,r)=>{if(this.destroyed||this._destroying)return;t&&(r=[]);const i={},n={},s={};let a=!1;r.forEach((e=>{"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(i[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(n[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(s[e.id]=e)}));const o=e=>{a=!0;let t=n[e.localCandidateId];t&&(t.ip||t.address)?(this.localAddress=t.ip||t.address,this.localPort=Number(t.port)):t&&t.ipAddress?(this.localAddress=t.ipAddress,this.localPort=Number(t.portNumber)):"string"==typeof e.googLocalAddress&&(t=e.googLocalAddress.split(":"),this.localAddress=t[0],this.localPort=Number(t[1])),this.localAddress&&(this.localFamily=this.localAddress.includes(":")?"IPv6":"IPv4");let r=i[e.remoteCandidateId];r&&(r.ip||r.address)?(this.remoteAddress=r.ip||r.address,this.remotePort=Number(r.port)):r&&r.ipAddress?(this.remoteAddress=r.ipAddress,this.remotePort=Number(r.portNumber)):"string"==typeof e.googRemoteAddress&&(r=e.googRemoteAddress.split(":"),this.remoteAddress=r[0],this.remotePort=Number(r[1])),this.remoteAddress&&(this.remoteFamily=this.remoteAddress.includes(":")?"IPv6":"IPv4"),this._debug("connect local: %s:%s remote: %s:%s",this.localAddress,this.localPort,this.remoteAddress,this.remotePort)};if(r.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId&&o(s[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&o(e)})),a||Object.keys(s).length&&!Object.keys(n).length){if(this._connecting=!1,this._connected=!0,this._chunk){try{this.send(this._chunk)}catch(t){return this.__destroy(ae(t,"ERR_DATA_CHANNEL"))}this._chunk=null,this._debug('sent chunk from "write before connect"');const e=this._cb;this._cb=null,e(null)}"number"!=typeof this._channel.bufferedAmountLowThreshold&&(this._interval=setInterval((()=>this._onInterval()),150),this._interval.unref&&this._interval.unref()),this._debug("connect"),this.emit("connect")}else setTimeout(e,100)}))};e()}_onInterval(){!this._cb||!this._channel||this._channel.bufferedAmount>ye||this._onChannelBufferedAmountLow()}_onSignalingStateChange(){this.destroyed||("stable"===this._pc.signalingState&&(this._isNegotiating=!1,this._debug("flushing sender queue",this._sendersAwaitingStable),this._sendersAwaitingStable.forEach((e=>{this._pc.removeTrack(e),this._queuedNegotiation=!0})),this._sendersAwaitingStable=[],this._queuedNegotiation?(this._debug("flushing negotiation queue"),this._queuedNegotiation=!1,this._needsNegotiation()):(this._debug("negotiated"),this.emit("negotiated"))),this._debug("signalingStateChange %s",this._pc.signalingState),this.emit("signalingStateChange",this._pc.signalingState))}_onIceCandidate(e){this.destroyed||(e.candidate&&this.trickle?this.emit("signal",{type:"candidate",candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||this._iceComplete||(this._iceComplete=!0,this.emit("_iceComplete")),e.candidate&&this._startIceCompleteTimeout())}_onChannelMessage(e){if(this.destroyed)return;let t=e.data;var r;t instanceof ArrayBuffer?t=new Uint8Array(t):!1===this.__objectMode&&(r=t,t=pe.encode(r)),this.push(t)}_onChannelBufferedAmountLow(){if(this.destroyed||!this._cb)return;this._debug("ending backpressure: bufferedAmount %d",this._channel.bufferedAmount);const e=this._cb;this._cb=null,e(null)}_onChannelOpen(){this._connected||this.destroyed||(this._debug("on channel open"),this._channelReady=!0,this._maybeReady())}_onChannelClose(){this.destroyed||(this._debug("on channel close"),this.__destroy())}_debug(){const e=[].slice.call(arguments);e[0]="["+this._id+"] "+e[0],ge.apply(null,e)}};we.WEBRTC_SUPPORT=!!j,we.config={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]}],sdpSemantics:"unified-plan"},we.channelConfig={};class Se extends we{constructor(e={}){super(e),this._pc&&(this.streams=e.streams||(e.stream?[e.stream]:[]),this._senderMap=new Map,this.streams&&this.streams.forEach((e=>{this.addStream(e)})),this._pc.ontrack=e=>{this._onTrack(e)})}addTransceiver(e,t){if(!this._destroying){if(this.destroyed)throw ae(Error("cannot addTransceiver after peer is destroyed"),"ERR_DESTROYED");if(this._debug("addTransceiver()"),this.initiator)try{this._pc.addTransceiver(e,t),this._needsNegotiation()}catch(e){this.__destroy(ae(e,"ERR_ADD_TRANSCEIVER"))}else this.emit("signal",{type:"transceiverRequest",transceiverRequest:{kind:e,init:t}})}}addStream(e){if(!this._destroying){if(this.destroyed)throw ae(Error("cannot addStream after peer is destroyed"),"ERR_DESTROYED");this._debug("addStream()"),e.getTracks().forEach((t=>{this.addTrack(t,e)}))}}addTrack(e,t){if(this._destroying)return;if(this.destroyed)throw ae(Error("cannot addTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("addTrack()");const r=this._senderMap.get(e)||new Map;let i=r.get(t);if(i)throw i.removed?ae(Error("Track has been removed. You should enable/disable tracks that you want to re-add."),"ERR_SENDER_REMOVED"):ae(Error("Track has already been added to that stream."),"ERR_SENDER_ALREADY_ADDED");i=this._pc.addTrack(e,t),r.set(t,i),this._senderMap.set(e,r),this._needsNegotiation()}replaceTrack(e,t,r){if(this._destroying)return;if(this.destroyed)throw ae(Error("cannot replaceTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("replaceTrack()");const i=this._senderMap.get(e),n=i?i.get(r):null;if(!n)throw ae(Error("Cannot replace track that was never added."),"ERR_TRACK_NOT_ADDED");t&&this._senderMap.set(t,i),null!=n.replaceTrack?n.replaceTrack(t):this.__destroy(ae(Error("replaceTrack is not supported in this browser"),"ERR_UNSUPPORTED_REPLACETRACK"))}removeTrack(e,t){if(this._destroying)return;if(this.destroyed)throw ae(Error("cannot removeTrack after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSender()");const r=this._senderMap.get(e),i=r?r.get(t):null;if(!i)throw ae(Error("Cannot remove track that was never added."),"ERR_TRACK_NOT_ADDED");try{i.removed=!0,this._pc.removeTrack(i)}catch(e){"NS_ERROR_UNEXPECTED"===e.name?this._sendersAwaitingStable.push(i):this.__destroy(ae(e,"ERR_REMOVE_TRACK"))}this._needsNegotiation()}removeStream(e){if(!this._destroying){if(this.destroyed)throw ae(Error("cannot removeStream after peer is destroyed"),"ERR_DESTROYED");this._debug("removeSenders()"),e.getTracks().forEach((t=>{this.removeTrack(t,e)}))}}_requestMissingTransceivers(){this._pc.getTransceivers&&this._pc.getTransceivers().forEach((e=>{e.mid||!e.sender.track||e.requested||(e.requested=!0,this.addTransceiver(e.sender.track.kind))}))}_onTrack(e){this.destroyed||e.streams.forEach((t=>{this._debug("on track"),this.emit("track",e.track,t),this._remoteTracks.push({track:e.track,stream:t}),this._remoteStreams.some((e=>e.id===t.id))||(this._remoteStreams.push(t),queueMicrotask((()=>{this._debug("on stream"),this.emit("stream",t)})))}))}}const Ce="data",ve="signal";var xe=(e,t)=>{const r=new Se({iceServers:[{urls:Ee}],...t,initiator:e,trickle:!1}),i=e=>n.push(e);let n=[];return r.on(Ce,i),{id:r._id,created:Date.now(),connection:r._pc,get channel(){return r._channel},get isDead(){return r.destroyed},signal(t){return new Promise((i=>{e||r.on(ve,i),r.signal(t)}))},sendData(e){return r.send(e)},destroy(){return r.destroy()},setHandlers(e){return Object.entries(e).forEach((([e,t])=>r.on(e,t)))},offerPromise:e?new Promise((e=>r.on(ve,e))):Promise.resolve(),addStream(e){return r.addStream(e)},removeStream(e){return r.removeStream(e)},addTrack(e,t){return r.addTrack(e,t)},removeTrack(e,t){return r.removeTrack(e,t)},replaceTrack(e,t,i){return r.replaceTrack(e,t,i)},drainEarlyData(e){r.off(Ce,i),n.forEach(e),n=null}}};const Ee=[...i(5,((e,t)=>`stun:stun${t||""}.l.google.com:19302`)),"stun:global.stun.twilio.com:3478"],Te=Object.getPrototypeOf(Uint8Array),ke=16369,Re=255,Ae="bufferedamountlow",Ne=e=>"@_"+e;const Le={},Fe={},Pe={},Oe={},Ie={},De={},Me={},je={},Ue=async e=>{if(Fe[e])return Fe[e];const t=(await x(e)).slice(0,20);return Fe[e]=t,Pe[t]=e,t},qe=async(e,t,r)=>e.send(b({action:"announce",info_hash:await Ue(t),peer_id:a,...r})),We=(e,t,i)=>console.warn(`${r}: torrent tracker ${i?"failure":"warning"} from ${e} - ${t}`),$e=(({init:e,subscribe:t,announce:n})=>{const s={};let f,_,S,v=!1;return(k,R,A)=>{const{appId:N}=k;if(s[N]?.[R])return s[N][R];const L={},F={},P=y(r,N,R),O=x(P),I=x(y(P,a)),D=(async(e,t,r)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},m(`${e}:${t}:${r}`)),{name:C},!1,["encrypt","decrypt"]))(k.password||"",N,R),M=e=>async t=>({type:t.type,sdp:await e(D,t.sdp)}),j=M(T),U=M(E),q=()=>xe(!0,k.rtcConfig),W=(e,t,r)=>{F[t]?F[t]!==e&&e.destroy():(F[t]=e,G(e,t),L[t]?.forEach(((e,t)=>{t!==r&&e.destroy()})),delete L[t])},$=(e,t)=>{F[t]===e&&delete F[t]},B=e=>(_.push(...i(e,q)),o(_.splice(0,e).map((e=>e.offerPromise.then(U).then((t=>({peer:e,offer:t}))))))),H=(e,t)=>A?.({error:`incorrect password (${k.password}) when decrypting ${t}`,appId:N,peerId:e,roomId:R}),Y=e=>async(t,r,i)=>{const[n,s]=await o([O,I]);if(t!==n&&t!==s)return;const{peerId:h,offer:d,answer:l,peer:c}="string"==typeof r?w(r):r;if(h!==a&&!F[h])if(!h||d||l){if(d){const t=L[h]?.[e];if(t&&a>h)return;const r=xe(!1,k.rtcConfig);let n;r.setHandlers({connect(){return W(r,h,e)},close(){return $(r,h)}});try{n=await j(d)}catch{return void H(h,"offer")}if(r.isDead)return;const[s,l]=await o([x(y(P,h)),r.signal(n)]);i(s,b({peerId:a,answer:await U(l)}))}else if(l){let t;try{t=await j(l)}catch(e){return void H(h,"answer")}if(c)c.setHandlers({connect(){return W(c,h,e)},close(){return $(c,h)}}),c.signal(t);else{const r=L[h]?.[e];r&&!r.isDead&&r.signal(t)}}}else{if(L[h]?.[e])return;const[[{peer:t,offer:r}],n]=await o([B(1),x(y(P,h))]);L[h]||=[],L[h][e]=t,setTimeout((()=>((e,t)=>{if(F[e])return;const r=L[e]?.[t];r&&(delete L[e][t],r.destroy())})(h,e)),.9*z[e]),t.setHandlers({connect(){return W(t,h,e)},close(){return $(t,h)}}),i(n,b({peerId:a,offer:r}))}};if(!k)throw p("requires a config map as the first argument");if(!N&&!k.firebaseApp)throw p("config map is missing appId field");if(!R)throw p("roomId argument required");if(!v){const t=e(k);_=i(20,q),f=Array.isArray(t)?t:[t],v=!0,S=setInterval((()=>_=_.filter((e=>{const t=Date.now()-e.created<57333;return t||e.destroy(),t}))),59052.99)}const z=f.map((()=>5333)),J=[],K=f.map((async(e,r)=>t(await e,await O,await I,Y(r),B)));o([O,I]).then((([e,t])=>{const r=async(i,s)=>{const a=await n(i,e,t);"number"==typeof a&&(z[s]=a),J[s]=setTimeout((()=>r(i,s)),z[s])};K.forEach((async(e,t)=>{await e,r(await f[t],t)}))}));let G=u;return s[N]||={},s[N][R]=((e,t,n)=>{const s={},a={},f={},_={},y={},S={},C={},v={onPeerJoin:u,onPeerLeave:u,onPeerStream:u,onPeerTrack:u},x=(e,t)=>(e?Array.isArray(e)?e:[e]:c(s)).flatMap((e=>{const i=s[e];return i?t(e,i):(console.warn(`${r}: no peer with id ${e} found`),[])})),E=e=>{s[e]&&(delete s[e],delete _[e],delete y[e],v.onPeerLeave(e),t(e))},T=e=>{if(a[e])return f[e];if(!e)throw p("action type argument is required");const t=m(e);if(t.byteLength>12)throw p(`action type string "${e}" (${t.byteLength}b) exceeds byte limit (12). Hint: choose a shorter name.`);const r=new Uint8Array(12);r.set(t);let n=0;return a[e]={onComplete:u,onProgress:u,setOnComplete:t=>a[e]={...a[e],onComplete:t},setOnProgress:t=>a[e]={...a[e],onProgress:t},async send(e,t,a,h){if(a&&"object"!=typeof a)throw p("action meta argument must be an object");const d=typeof e;if("undefined"===d)throw p("action data cannot be undefined");const l="string"!==d,c=e instanceof Blob,u=c||e instanceof ArrayBuffer||e instanceof Te;if(a&&!u)throw p("action meta argument can only be used with binary data");const f=u?new Uint8Array(c?await e.arrayBuffer():e):m(l?b(e):e),_=a?m(b(a)):null,g=Math.ceil(f.byteLength/ke)+(a?1:0)||1,y=i(g,((e,t)=>{const i=t===g-1,s=a&&0===t,o=new Uint8Array(15+(s?_.byteLength:i?f.byteLength-ke*(g-(a?2:1)):ke));return o.set(r),o.set([n],12),o.set([i|s<<1|u<<2|l<<3],13),o.set([Math.round((t+1)/g*Re)],14),o.set(a?s?_:f.subarray((t-1)*ke,t*ke):f.subarray(t*ke,(t+1)*ke),15),o}));return n=n+1&Re,o(x(t,(async(e,t)=>{const{channel:r}=t;let i=0;for(;i<g;){const n=y[i];if(r.bufferedAmount>r.bufferedAmountLowThreshold&&await new Promise((e=>{const t=()=>{r.removeEventListener(Ae,t),e()};r.addEventListener(Ae,t)})),!s[e])break;t.sendData(n),i++,h?.(n[14]/Re,e,a)}})))}},f[e]||=[a[e].send,a[e].setOnComplete,a[e].setOnProgress]},k=(e,t)=>{const i=new Uint8Array(t),n=g(i.subarray(0,12)).replaceAll("\0",""),[s]=i.subarray(12,13),[o]=i.subarray(13,14),[h]=i.subarray(14,15),d=i.subarray(15),l=!!(1&o),c=!!(2&o),u=!!(4&o),p=!!(8&o);if(!a[n])return void console.warn(`${r}: received message with unregistered type (${n})`);_[e]||={},_[e][n]||={};const f=_[e][n][s]||={chunks:[]};if(c?f.meta=w(g(d)):f.chunks.push(d),a[n].onProgress(h/Re,e,f.meta),!l)return;const m=new Uint8Array(f.chunks.reduce(((e,t)=>e+t.byteLength),0));if(f.chunks.reduce(((e,t)=>(m.set(t,e),e+t.byteLength)),0),delete _[e][n][s],u)a[n].onComplete(m,e,f.meta);else{const t=g(m);a[n].onComplete(p?w(t):t,e)}},R=async()=>{await U(""),await new Promise((e=>setTimeout(e,99))),d(s).forEach((([e,t])=>{t.destroy(),delete s[e]})),n()},[A,N]=T(Ne("ping")),[L,F]=T(Ne("pong")),[P,O]=T(Ne("signal")),[I,D]=T(Ne("stream")),[M,j]=T(Ne("track")),[U,q]=T(Ne("leave"));return e(((e,t)=>{s[t]||(s[t]=e,e.setHandlers({data:e=>k(t,e),stream(e){v.onPeerStream(e,t,S[t]),delete S[t]},track(e,r){v.onPeerTrack(e,r,t,C[t]),delete C[t]},signal:e=>P(e,t),close:()=>E(t),error:()=>E(t)}),v.onPeerJoin(t),e.drainEarlyData?.((e=>k(t,e))))})),N(((e,t)=>L("",t))),F(((e,t)=>{y[t]?.(),delete y[t]})),O(((e,t)=>s[t]?.signal(e))),D(((e,t)=>S[t]=e)),j(((e,t)=>C[t]=e)),q(((e,t)=>E(t))),h&&addEventListener("beforeunload",R),{makeAction:T,leave:R,async ping(e){if(!e)throw p("ping() must be called with target peer ID");const t=Date.now();return A("",e),await new Promise((t=>y[e]=t)),Date.now()-t},getPeers:()=>l(d(s).map((([e,t])=>[e,t.connection]))),addStream:(e,t,r)=>x(t,(async(t,i)=>{r&&await I(r,t),i.addStream(e)})),removeStream:(e,t)=>x(t,((t,r)=>r.removeStream(e))),addTrack:(e,t,r,i)=>x(r,(async(r,n)=>{i&&await M(i,r),n.addTrack(e,t)})),removeTrack:(e,t,r)=>x(r,((r,i)=>i.removeTrack(e,t))),replaceTrack:(e,t,r,i,n)=>x(i,(async(i,s)=>{n&&await M(n,i),s.replaceTrack(e,t,r)})),onPeerJoin:e=>v.onPeerJoin=e,onPeerLeave:e=>v.onPeerLeave=e,onPeerStream:e=>v.onPeerStream=e,onPeerTrack:e=>v.onPeerTrack=e}})((e=>G=e),(e=>delete F[e]),(()=>{delete s[N][R],J.forEach(clearTimeout),K.forEach((async e=>(await e)())),clearInterval(S)}))}})({init(e){return((e,t,r)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||r))(e,Ye,3).map((e=>{const t=((e,t)=>{const r={},i=()=>{const n=new WebSocket(e);n.onclose=()=>{S[e]??=3333,setTimeout(i,S[e]),S[e]*=2},n.onmessage=e=>t(e.data),r.socket=n,r.url=n.url,r.ready=new Promise((t=>n.onopen=()=>{t(r),S[e]=3333})),r.send=e=>{1===n.readyState&&n.send(e)}};return i(),r})(e,(e=>{const t=w(e),i=t["failure reason"],n=t["warning message"],{interval:s}=t,a=Pe[t.info_hash];if(i)We(r,i,!0);else{if(n&&We(r,n),s&&1e3*s>De[r]&&Ie[r][a]){const e=Math.min(1e3*s,120333);clearInterval(Oe[r][a]),De[r]=e,Oe[r][a]=setInterval(Ie[r][a],e)}Me[t.offer_id]||(t.offer||t.answer)&&(Me[t.offer_id]=!0,je[r][a]?.(t))}})),{url:r}=t;return Le[r]=t,je[r]={},t.ready}))},subscribe(e,t,r,i,n){const{url:a}=e,o=async()=>{const r=l((await n(10)).map((e=>[s(20),e])));je[e.url][t]=n=>{if(n.offer)i(t,{offer:n.offer,peerId:n.peer_id},((r,i)=>qe(e,t,{answer:w(i).answer,offer_id:n.offer_id,to_peer_id:n.peer_id})));else if(n.answer){const e=r[n.offer_id];e&&i(t,{answer:n.answer,peerId:n.peer_id,peer:e.peer})}},qe(e,t,{numwant:10,offers:d(r).map((([e,{offer:t}])=>({offer_id:e,offer:t})))})};return De[a]=33333,Ie[a]||={},Ie[a][t]=o,Oe[a]||={},Oe[a][t]=setInterval(o,De[a]),o(),()=>{clearInterval(Oe[a][t]),delete je[a][t],delete Ie[a][t]}},announce(e){return De[e.url]}}),Be=(He=Le,()=>l(d(He).map((([e,t])=>[e,t.socket]))));var He;const Ye=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map((e=>"wss://"+e));export{Ye as defaultRelayUrls,Be as getRelaySockets,$e as joinRoom,a as selfId};